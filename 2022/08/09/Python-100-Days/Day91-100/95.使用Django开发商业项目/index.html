<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>95.使用Django开发商业项目 | HExLL</title><meta name="keywords" content="Python,Day91-100"><meta name="author" content="GreenSeaa"><meta name="copyright" content="GreenSeaa"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="使用Django开发商业项目  说明：本文的部分插图来自于《Python项目开发实战》和《精通Django》，这两本书中都包含了对Django框架精彩的讲解，有兴趣的读者可以自行购买阅读。  Web应用 问题1：描述一个Web应用的工作流程。  问题2：描述项目的物理架构。（上图中补充负载均衡（反向代理）服务器、数据库服务器、文件服务器、邮件服务器、缓存服务器、防火墙等，而且每个节点都有可能是多节">
<meta property="og:type" content="article">
<meta property="og:title" content="95.使用Django开发商业项目">
<meta property="og:url" content="https://yuanweize.github.io/2022/08/09/Python-100-Days/Day91-100/95.%E4%BD%BF%E7%94%A8Django%E5%BC%80%E5%8F%91%E5%95%86%E4%B8%9A%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="HExLL">
<meta property="og:description" content="使用Django开发商业项目  说明：本文的部分插图来自于《Python项目开发实战》和《精通Django》，这两本书中都包含了对Django框架精彩的讲解，有兴趣的读者可以自行购买阅读。  Web应用 问题1：描述一个Web应用的工作流程。  问题2：描述项目的物理架构。（上图中补充负载均衡（反向代理）服务器、数据库服务器、文件服务器、邮件服务器、缓存服务器、防火墙等，而且每个节点都有可能是多节">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2022-08-09T05:39:48.000Z">
<meta property="article:modified_time" content="2022-08-09T15:08:27.567Z">
<meta property="article:author" content="GreenSeaa">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Day91-100">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yuanweize.github.io/2022/08/09/Python-100-Days/Day91-100/95.%E4%BD%BF%E7%94%A8Django%E5%BC%80%E5%8F%91%E5%95%86%E4%B8%9A%E9%A1%B9%E7%9B%AE/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"SW7OVVVFHX","apiKey":"5d05023a8579462e72ea704e4f43cf3f","indexName":"hexo","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '95.使用Django开发商业项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '09-08-2022 17:08:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s.gravatar.com/avatar/50de7ee8a1fc96ada7495a641400642d?s=512" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">801</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">70</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">69</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://app.plex.tv/"><i class="fa-fw fas fa-video"></i><span> Movie[PLEX]</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://command.yuanweize.win/"><i class="fa-fw fab fa-linux"></i><span> Linux-command</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">HExLL</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://app.plex.tv/"><i class="fa-fw fas fa-video"></i><span> Movie[PLEX]</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://command.yuanweize.win/"><i class="fa-fw fab fa-linux"></i><span> Linux-command</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">95.使用Django开发商业项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-09T05:39:48.000Z" title="发表于 09-08-2022 07:39:48">09-08-2022</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-09T15:08:27.567Z" title="更新于 09-08-2022 17:08:27">09-08-2022</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Python-100-Days/">Python-100-Days</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Python-100-Days/Day91-100/">Day91-100</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>63分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="95.使用Django开发商业项目"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="使用Django开发商业项目">使用Django开发商业项目</h2>
<blockquote>
<p><strong>说明</strong>：本文的部分插图来自于《Python项目开发实战》和《精通Django》，这两本书中都包含了对Django框架精彩的讲解，有兴趣的读者可以自行购买阅读。</p>
</blockquote>
<h3 id="Web应用">Web应用</h3>
<p>问题1：描述一个Web应用的工作流程。</p>
<p><img src="./res/web-application.png" alt=""></p>
<p>问题2：描述项目的物理架构。（上图中补充负载均衡（反向代理）服务器、数据库服务器、文件服务器、邮件服务器、缓存服务器、防火墙等，而且每个节点都有可能是多节点构成的集群。当然，架构都是根据业务的需要一步步演进而不是一蹴而就的。）</p>
<p>问题3：描述Django项目的工作流程。（如下图所示）</p>
<p><img src="./res/django_request_response_cycle.png" alt=""></p>
<h3 id="MVC架构模式">MVC架构模式</h3>
<p>问题1：为什么要使用MVC架构模式？（模型和视图解耦合）</p>
<p>问题2：MVC架构中每个部分的作用？（如下图所示）</p>
<p><img src="./res/mvc.png" alt=""></p>
<h3 id="HTTP请求和响应">HTTP请求和响应</h3>
<h4 id="HTTP请求-请求行-请求头-空行-消息体">HTTP请求 = 请求行+请求头+空行+[消息体]</h4>
<p><img src="./res/http-request.png" alt=""></p>
<h4 id="HTTP响应-响应行-响应头-空行-消息体">HTTP响应 = 响应行+响应头+空行+消息体</h4>
<p><img src="./res/http-response.png" alt=""></p>
<ol>
<li>
<p><code>HTTPRequest</code>对象的属性和方法：</p>
<ul>
<li><code>method</code> - 获取请求方法</li>
<li><code>path</code> / <code>get_full_path()</code> - 获取请求路径/带查询字符串的路径</li>
<li><code>scheme</code> / <code>is_secure()</code> / <code>get_host()</code> / <code>get_port()</code> - 获取请求的协议/主机/端口</li>
<li><code>META</code> / <code>COOKIES</code> - 获取请求头/Cookie信息</li>
<li><code>GET</code> / <code>POST</code> / <code>FILES</code> - 获取GET或POST请求参数/上传的文件</li>
<li><code>get_signed_cookie()</code> - 获取带签名的Cookie</li>
<li><code>is_ajax()</code> - 是不是Ajax异步请求</li>
<li><code>body</code> / <code>content_type</code> / <code>encoding</code> - 获取请求的消息体（bytes流）/MIME类型/编码</li>
</ul>
</li>
<li>
<p>中间件添加的属性：</p>
<ul>
<li><code>session</code> / <code>user</code> / <code>site</code></li>
</ul>
</li>
<li>
<p><code>HttpResponse</code>对象的属性和方法：</p>
<ul>
<li><code>set_cookie()</code> / <code>set_signed_cookie()</code> / <code>delete_cookie()</code> - 添加/删除Cookie</li>
<li><code>__setitem__</code> / <code>__getitem__</code> / <code>__delitem__</code> - 添加/获取/删除响应头</li>
<li><code>charset</code> / <code>content</code> / <code>status_code</code> - 响应的字符集/消息体（bytes流）/状态码
<ul>
<li>1xx：请求已经收到，继续处理</li>
<li>2xx（成功）：请求已经成功收到、理解和接收。</li>
<li>3xx（重定向）：为完成请求要继续执行后续的操作。</li>
<li>4xx（客户端错误）：请求不正确或不能够被受理。</li>
<li>5xx（服务器错误）：服务器处理请求失败。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>JsonResponse</code>（<code>HttpResponse</code>的子类型）对象</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response = JsonResponse(&#123;<span class="string">&#x27;foo&#x27;</span>: <span class="string">&#x27;bar&#x27;</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response.content</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response = JsonResponse([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], safe=<span class="literal">False</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response.content</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response = HttpResponse(<span class="string">b&#x27;...&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response[<span class="string">&#x27;cotent-type&#x27;</span>] = <span class="string">&#x27;application/pdf&#x27;</span>;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response[<span class="string">&#x27;content-disposition&#x27;</span>] = <span class="string">&#x27;inline; filename=&quot;xyz.pdf&quot;&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response[<span class="string">&#x27;content-disposition&#x27;</span>] = <span class="string">&#x27;attachment; filename=&quot;xyz.pdf&quot;&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response.set_signed_cookie(<span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>, salt=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response.status_code = <span class="number">200</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="数据模型-Model">数据模型(Model)</h3>
<p>问题1：关系型数据库表的设计应该注意哪些问题（范式理论和逆范式）？如何通过表来创建模型类（反向工程）？如何通过模型类来创建表（正向工程）？</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python manage.py makemigrations &lt;appname&gt;</span><br><span class="line">python manage.py migrate</span><br><span class="line"></span><br><span class="line">python manage.py inspectdb &gt; &lt;appname&gt;/models.py</span><br></pre></td></tr></table></figure>
<p>问题2：关系型数据库中数据完整性指的是什么？什么时候需要牺牲数据完整性？（实体完整性/参照完整性/域完整性）</p>
<p>问题3：ORM是什么以及解决了什么问题？（对象模型-关系模型双向转换）</p>
<ol>
<li>
<p><code>Field</code>及其子类的属性：</p>
<ul>
<li>通用选项：
<ul>
<li><code>db_column</code> / <code>db_tablespace</code></li>
<li><code>null</code> / <code>blank</code> / <code>default</code></li>
<li><code>primary_key</code></li>
<li><code>db_index</code> / <code>unqiue</code></li>
<li><code>choices</code> / <code>help_text</code> / <code>error_message</code> / <code>editable</code> / <code>hidden</code></li>
</ul>
</li>
<li>其他选项：
<ul>
<li><code>CharField</code>: <code>max_length</code></li>
<li><code>DateField</code>: <code>auto_now</code> / <code>auto_now_add</code></li>
<li><code>DecimalField</code>: <code>max_digits</code> / <code>decimal_places</code></li>
<li><code>FileField</code>: <code>storage</code> / <code>upload_to</code></li>
<li><code>ImageField</code>: <code>height_field</code> / <code>width_field</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>ForeignKey</code>的属性：</p>
<ul>
<li>
<p>重要属性：</p>
<ul>
<li>
<p><code>db_constraint</code>（提升性能或者数据分片的情况可能需要设置为<code>False</code>）</p>
</li>
<li>
<p><code>on_delete</code></p>
<ul>
<li><code>CASCADE</code>：级联删除。</li>
</ul>
<ul>
<li><code>PROTECT</code>：抛出<code>ProtectedError</code>异常，阻止删除引用的对象。</li>
<li><code>SET_NULL</code>：把外键设置为<code>null</code>，当<code>null</code>属性被设置为<code>True</code>时才能这么做。</li>
<li><code>SET_DEFAULT</code>：把外键设置为默认值，提供了默认值才能这么做。</li>
</ul>
</li>
<li>
<p><code>related_name</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dept</span>(models.Model):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Emp</span>(models.Model):</span><br><span class="line">    dept = models.ForeignKey(related_name=<span class="string">&#x27;+&#x27;</span>, ...)</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line">Dept.objects.get(no=<span class="number">10</span>).emp_set.<span class="built_in">all</span>()</span><br><span class="line">Emp.objects.<span class="built_in">filter</span>(dept__no=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：<code>related_name</code>设置为<code>'+'</code>，可以防止一对多外键关联从“一”的一方查询“多”的一方。</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>其他属性：</p>
<ul>
<li><code>to_field</code> / <code>limit_choices_to</code> / <code>swappable</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>Model</code>的属性和方法</p>
<ul>
<li>
<p><code>objects</code> / <code>pk</code></p>
</li>
<li>
<p><code>save()</code> / <code>delete()</code></p>
</li>
<li>
<p><code>clean()</code> / <code>validate_unique()</code> / <code>full_clean()</code></p>
</li>
</ul>
</li>
<li>
<p><code>QuerySet</code>的方法</p>
<ul>
<li>
<p><code>get()</code> / <code>all()</code> / <code>values()</code></p>
<blockquote>
<p>说明：<code>values()</code>返回的<code>QuerySet</code>中不是模型对象而是字典</p>
</blockquote>
</li>
<li>
<p><code>count()</code> / <code>order_by()</code> / <code>exists()</code> / <code>reverse()</code></p>
</li>
<li>
<p><code>filter()</code> / <code>exclude()</code></p>
<ul>
<li>
<p><code>exact</code> / <code>iexact</code>：精确匹配/忽略大小写的精确匹配查询</p>
</li>
<li>
<p><code>contains</code> / <code>icontains</code> / <code>startswith / istartswith / endswith / iendswith</code>：基于<code>like</code>的模糊查询</p>
</li>
<li>
<p><code>in</code>：集合运算</p>
</li>
<li>
<p><code>gt</code> / <code>gte</code> / <code>lt</code> / <code>lte</code>：大于/大于等于/小于/小于等于关系运算</p>
</li>
<li>
<p><code>range</code>：指定范围查询（SQL中的<code>between…and…</code>）</p>
</li>
<li>
<p><code>year</code> / <code>month</code> / <code>day</code> / <code>week_day</code> / <code>hour</code> / <code>minute</code> / <code>second</code>：查询时间日期</p>
</li>
<li>
<p><code>isnull</code>：查询空值（<code>True</code>）或非空值（<code>False</code>）</p>
</li>
<li>
<p><code>search</code>：基于全文索引的全文检索</p>
</li>
<li>
<p><code>regex</code> / <code>iregex</code>：基于正则表达式的模糊匹配查询</p>
</li>
<li>
<p><code>aggregate()</code> / <code>annotate()</code></p>
</li>
<li>
<p><code>Avg</code> / <code>Count</code> / <code>Sum</code> / <code>Max</code> / <code>Min</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Emp.objects.aggregate(avg_sal=Avg(<span class="string">&#x27;sal&#x27;</span>))</span><br><span class="line">(<span class="number">0.001</span>) SELECT AVG(`TbEmp`.`sal`) AS `avg_sal` FROM `TbEmp`; args=()</span><br><span class="line">&#123;<span class="string">&#x27;avg_sal&#x27;</span>: <span class="number">3521.4286</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Emp.objects.values(<span class="string">&#x27;dept&#x27;</span>).annotate(total=Count(<span class="string">&#x27;dept&#x27;</span>))</span><br><span class="line">(<span class="number">0.001</span>) SELECT `TbEmp`.`dno`, COUNT(`TbEmp`.`dno`) AS `total` FROM `TbEmp` GROUP BY `TbEmp`.`dno` ORDER BY NULL LIMIT <span class="number">21</span>; args=()</span><br><span class="line">&lt;QuerySet [&#123;<span class="string">&#x27;dept&#x27;</span>: <span class="number">10</span>, <span class="string">&#x27;total&#x27;</span>: <span class="number">4</span>&#125;, &#123;<span class="string">&#x27;dept&#x27;</span>: <span class="number">20</span>, <span class="string">&#x27;total&#x27;</span>: <span class="number">7</span>&#125;, &#123;<span class="string">&#x27;dept&#x27;</span>: <span class="number">30</span>, <span class="string">&#x27;total&#x27;</span>: <span class="number">3</span>&#125;]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><code>first()</code> / <code>last()</code></p>
<blockquote>
<p>说明：调用<code>first()</code>方法相当于用<code>[0]</code>对<code>QuerySet</code>进行切片。</p>
</blockquote>
</li>
<li>
<p><code>only()</code> / <code>defer()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Emp.objects.<span class="built_in">filter</span>(pk=<span class="number">7800</span>).only(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;sal&#x27;</span>)</span><br><span class="line">(<span class="number">0.001</span>) SELECT `TbEmp`.`empno`, `TbEmp`.`ename`, `TbEmp`.`sal` FROM `TbEmp` WHERE `TbEmp`.`empno` = <span class="number">7800</span> LIMIT <span class="number">21</span>; args=(<span class="number">7800</span>,)</span><br><span class="line">&lt;QuerySet [&lt;Emp: Emp <span class="built_in">object</span> (<span class="number">7800</span>)&gt;]&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Emp.objects.<span class="built_in">filter</span>(pk=<span class="number">7800</span>).defer(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;sal&#x27;</span>)</span><br><span class="line">(<span class="number">0.001</span>) SELECT `TbEmp`.`empno`, `TbEmp`.`job`, `TbEmp`.`mgr`, `TbEmp`.`comm`, `TbEmp`.`dno` FROM `TbEmp` WHERE `TbEmp`.`empno` = <span class="number">7800</span> LIMIT <span class="number">21</span>; args=(<span class="number">7800</span>,)</span><br><span class="line">&lt;QuerySet [&lt;Emp: Emp <span class="built_in">object</span> (<span class="number">7800</span>)&gt;]&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>create()</code> / <code>update()</code> / <code>raw()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Emp.objects.<span class="built_in">filter</span>(dept__no=<span class="number">20</span>).update(sal=F(<span class="string">&#x27;sal&#x27;</span>) + <span class="number">100</span>)</span><br><span class="line">(<span class="number">0.011</span>) UPDATE `TbEmp` SET `sal` = (`TbEmp`.`sal` + <span class="number">100</span>) WHERE `TbEmp`.`dno` = <span class="number">20</span>; args=(<span class="number">100</span>, <span class="number">20</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Emp.objects.raw(<span class="string">&#x27;select empno, ename, job from TbEmp where dno=10&#x27;</span>)</span><br><span class="line">&lt;RawQuerySet: select empno, ename, job <span class="keyword">from</span> TbEmp where dno=<span class="number">10</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><code>Q</code>对象和<code>F</code>对象</p>
<blockquote>
<p>说明：Q对象主要用来解决多条件组合的复杂查询；F对象主要用于更新数据。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Emp.objects.<span class="built_in">filter</span>(</span><br><span class="line"><span class="meta">... </span>    Q(name__startswith=<span class="string">&#x27;张&#x27;</span>),</span><br><span class="line"><span class="meta">... </span>    Q(sal__lte=<span class="number">5000</span>) | Q(comm__gte=<span class="number">1000</span>)</span><br><span class="line"><span class="meta">... </span>) <span class="comment"># 查询名字以“张”开头且工资小于等于5000或补贴大于等于1000的员工</span></span><br><span class="line">&lt;QuerySet [&lt;Emp: 张三丰&gt;]&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> backend.models <span class="keyword">import</span> Emp, Dept</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>emps = Emp.objects.<span class="built_in">filter</span>(dept__no=<span class="number">20</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>emps.update(sal=F(<span class="string">&#x27;sal&#x27;</span>) + <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>原生SQL查询</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> connections</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> connections[<span class="string">&#x27;...&#x27;</span>].cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">    cursor.execute(<span class="string">&quot;UPDATE TbEmp SET sal=sal+10 WHERE dno=30&quot;</span>)</span><br><span class="line">    cursor.execute(<span class="string">&quot;SELECT ename, job FROM TbEmp WHERE dno=10&quot;</span>)</span><br><span class="line">    row = cursor.fetchall()</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>模型管理器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BookManager</span>(models.Manager):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">title_count</span>(<span class="params">self, keyword</span>):</span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">filter</span>(title__icontains=keyword).count()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(models.Model):</span><br><span class="line">    </span><br><span class="line">    objects = BookManager()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="视图函数-Controller">视图函数(Controller)</h3>
<h4 id="如何设计视图函数">如何设计视图函数</h4>
<ol>
<li>
<p>用户的每个请求（用户故事）对应一个视图函数，当然也可以将用户要执行的业务逻辑封装到独立的函数中，也就是有专门的模块处理程序中的业务逻辑。</p>
</li>
<li>
<p>用户的请求可能会包含多个（持久化）操作，这些操作有可能需要设计成不可分割的原子性操作，那么这里就形成了事务的边界。</p>
<ul>
<li>
<p>事务的ACID特性。</p>
<ul>
<li>原子性（Atomicity）：事务中各项的操作要么全做要么全不做；</li>
<li>一致性（Consistentcy）：事务前后系统的状态是一致的；</li>
<li>隔离性（Isolation）：并发执行的事务无法看到彼此的中间状态；</li>
<li>持久性（Duration）：事务完成后所做的改动都会被持久化。</li>
</ul>
</li>
<li>
<p>事务隔离级别 - 设置事务隔离级别是为了数据库底层依据事务隔离级别为数据加上适当的锁。如果需要保证数据的强一致性，那么关系型数据库仍然是唯一的也是最好的选择，因为关系型数据库可以通过锁机制来保护数据。事务隔离级别从低到高依次是：Read Uncommitted（读未提交）、Read Committed（读提交）、Repeatable Read（可重复读）、Serializable（串行化）。事务隔离级别越高，数据并发访问的问题越少，但是性能越差；事务隔离级别越低，数据并发访问的问题越多，但是性能越好。</p>
</li>
<li>
<p>数据并发访问会产生5种问题（请参考我的<a target="_blank" rel="noopener" href="https://blog.csdn.net/jackfrued/article/details/44921941">《Java面试题全集（上）》</a>第80题对该问题的讲解）：</p>
<ul>
<li>第1类丢失更新（A事务撤销覆盖B事务更新的数据）和第2类丢失更新（A事务提交覆盖B事务更新的数据）。</li>
<li>脏读（读脏数据）：一个事务读取到其他尚未提交的事务的数据。</li>
<li>不可重复读： 一个事务在读取它的查询结果时，被另一个事务更新了它的查询记录导致无法读到数据。</li>
<li>幻读：一个事务在读取它的查询结果时，发现读到了被另一个事务提交的新数据。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 设置全局默认的事务隔离级别</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level repeatable read;</span><br><span class="line"><span class="comment">-- 设置当前会话的事务隔离级别</span></span><br><span class="line"><span class="keyword">set</span> session transaction isolation level read committed;</span><br><span class="line"><span class="comment">-- 查询当前会话的事务隔离级别</span></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@tx</span>_isolation;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Django中的事务控制。</p>
<ul>
<li>
<p>给每个请求绑定事务环境（反模式）。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ATOMIC_REQUESTS = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用事务装饰器（简单易用） - 粗粒度（控制不够精细）。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@transaction.non_atomic_requests</span></span><br><span class="line"><span class="meta">@transaction.atomic</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用上下文语法（细粒度 - 事务控制的范围更加精准）。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> transaction.atomic():</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>关闭自动提交使用手动提交。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">AUTOCOMMIT = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">transaction.commit()</span><br><span class="line">transaction.rollback()</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="URL配置">URL配置</h4>
<ol>
<li>
<p>可以让部分URL只在调试模式下生效。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">    urlpatterns += [ ... ]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以使用命名捕获组捕获路径参数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url(<span class="string">r&#x27;api/code/(?P&lt;mobile&gt;1[3-9]\d&#123;9&#125;)&#x27;</span>),</span><br><span class="line">path(<span class="string">&#x27;api/code/&lt;str:mobile&gt;&#x27;</span>),</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>URL配置不关心请求使用的方法（一个视图函数可以处理不同的请求方式）。</p>
</li>
<li>
<p>如果使用<code>url</code>函数捕获的路径参数都是字符串，<code>path</code>函数可以指定路径参数类型。</p>
</li>
<li>
<p>可以使用<code>include</code>函数引入其他URL配置并指定<code>namespace</code>来解决命名冲突，捕获的参数会向下传递。</p>
</li>
<li>
<p>在<code>url</code>和<code>path</code>函数甚至是<code>include</code>函数中都可以用字典向视图传入额外的参数，如果参数与捕获的参数同名，则使用字典中的参数。</p>
</li>
<li>
<p>可以用<code>reverse</code>函数实现URL的逆向解析（从名字解析出URL），在模板中也可以用<code>&#123;% url %&#125;</code>实现同样的操作。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">path(<span class="string">&#x27;&#x27;</span>, views.index, name=<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> redirect(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"><span class="keyword">return</span> redirect(<span class="string">&#x27;index&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="模板-View">模板(View)</h3>
<h4 id="后端渲染">后端渲染</h4>
<ol>
<li>
<p>模板的配置和渲染函数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR, <span class="string">&#x27;templates&#x27;</span>), ],</span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">resp = render(request, <span class="string">&#x27;index.html&#x27;</span>, &#123;<span class="string">&#x27;foo&#x27;</span>: ...&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>模板遇到变量名的查找顺序。</p>
<ul>
<li>字典查找（如：<code>foo['bar']</code>）</li>
<li>属性查找（如：<code>foo.bar</code>）</li>
<li>方法调用（如：<code>foo.bar()</code>）
<ul>
<li>方法不能有必须传值的参数</li>
<li>在模板中不能够给方法传参</li>
<li>如果方法的<code>alters_data</code>被设置为<code>True</code>则不能调用该方法（避免误操作的风险），模型对象动态生成的<code>delete()</code>和<code>save()</code>方法都设定了<code>alters_data = True</code>。</li>
</ul>
</li>
<li>列表索引查找（如：<code>foo[0]</code>）</li>
</ul>
</li>
<li>
<p>模板标签的使用。</p>
<ul>
<li><code>&#123;% if %&#125;` / `&#123;% else %&#125;` / `&#123;% endif %&#125;</code></li>
<li><code>&#123;% for %&#125;` / `&#123;% endfor %&#125;</code></li>
<li><code>&#123;% ifequal %&#125;` / `&#123;% endifequal %&#125;</code> / <code>&#123;% ifnotequal %&#125;` / `&#123;% endifnotequal %&#125;</code></li>
<li>`` / <code>&#123;% comment %&#125;` / `&#123;% endcomment %&#125;</code></li>
</ul>
</li>
<li>
<p>过滤器的使用。</p>
<ul>
<li><code>lower</code> / <code>upper</code> / <code>first</code> / <code>last</code> / <code>truncatewords</code> / <code>date </code>/ <code>time</code> / <code>length</code> / <code>pluralize</code> / <code>center</code> / <code>ljust</code> / <code>rjust</code> / <code>cut</code> / <code>urlencode</code> / <code>default_if_none</code> / <code>filesizeformat</code> / <code>join</code> / <code>slice</code> / <code>slugify</code></li>
</ul>
</li>
<li>
<p>模板的包含和继承。</p>
<ul>
<li><code>&#123;% include %&#125;</code> / <code>&#123;% block %&#125;</code></li>
<li><code>&#123;% extends %&#125;</code></li>
</ul>
</li>
<li>
<p>模板加载器（后面优化部分会讲到）。</p>
<ul>
<li>
<p>文件系统加载器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">TEMPLATES = [&#123;</span><br><span class="line">    <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR, <span class="string">&#x27;templates&#x27;</span>)],</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>应用目录加载器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">TEMPLATES = [&#123;</span><br><span class="line">    <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h4 id="前端渲染">前端渲染</h4>
<ol>
<li>前端模板引擎：Handlebars / Mustache。</li>
<li>前端MV*框架。
<ul>
<li>MVC - AngularJS</li>
<li>MVVM(Model-View-ViewModel) - Vue.js</li>
</ul>
</li>
</ol>
<h4 id="其他视图">其他视图</h4>
<ol>
<li>
<p>MIME（多用途Internet邮件扩展）类型 - 告知浏览器传输的数据类型。</p>
<table>
<thead>
<tr>
<th>Content-Type</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>application/json</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/JSON">JSON</a>（JavaScript Object Notation）</td>
</tr>
<tr>
<td>application/pdf</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PDF">PDF</a>（Portable Document Format）</td>
</tr>
<tr>
<td>audio/mpeg</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/MP3">MP3</a>或其他<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/MPEG">MPEG</a>音频文件</td>
</tr>
<tr>
<td>audio/vnd.wave</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/WAV">WAV</a>音频文件</td>
</tr>
<tr>
<td>image/gif</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/GIF">GIF</a>图像文件</td>
</tr>
<tr>
<td>image/jpeg</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/JPEG">JPEG</a>图像文件</td>
</tr>
<tr>
<td>image/png</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PNG">PNG</a>图像文件</td>
</tr>
<tr>
<td>text/html</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/HTML">HTML</a>文件</td>
</tr>
<tr>
<td>text/xml</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/XML">XML</a></td>
</tr>
<tr>
<td>video/mp4</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/MP4">MP4</a>视频文件</td>
</tr>
<tr>
<td>video/quicktime</td>
<td><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/QuickTime">QuickTime</a>视频文件</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>如何处置生成的内容（inline / attachment）。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response[<span class="string">&#x27;content-type&#x27;</span>] = <span class="string">&#x27;application/pdf&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>filename = quote(<span class="string">&#x27;Python语言规范.pdf&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>filename</span><br><span class="line"><span class="string">&#x27;Python%E8%AF%AD%E8%A8%80%E8%A7%84%E8%8C%83.pdf&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response[<span class="string">&#x27;content-disposition&#x27;</span>] = <span class="string">f&#x27;attachment; filename=&quot;<span class="subst">&#123;filename&#125;</span>&quot;&#x27;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>提醒：URL以及请求和响应头中的中文都应该处理成<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E7%99%BE%E5%88%86%E5%8F%B7%E7%BC%96%E7%A0%81">百分号编码</a>。</p>
</blockquote>
</li>
<li>
<p>生成CSV / Excel / PDF / 统计报表。</p>
<ul>
<li>
<p>向浏览器传输二进制数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line">buffer = BytesIO()</span><br><span class="line"></span><br><span class="line">resp = HttpResponse(content_type=<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">resp[<span class="string">&#x27;Content-Disposition&#x27;</span>] = <span class="string">&#x27;attachment; filename=&quot;...&quot;&#x27;</span></span><br><span class="line">resp.write(buffer.getvalue())</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xlwt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_style</span>(<span class="params">name, color=<span class="number">0</span>, bold=<span class="literal">False</span>, italic=<span class="literal">False</span></span>):</span><br><span class="line">    font = xlwt.Font()</span><br><span class="line">    font.name, font.colour_index, font.bold, font.italic = \</span><br><span class="line">    	name, color, bold, italic</span><br><span class="line">    style = xlwt.XFStyle()</span><br><span class="line">    style.font = font</span><br><span class="line">    <span class="keyword">return</span> style</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">export_emp_excel</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="comment"># 创建Excel工作簿(使用三方库xlwt)</span></span><br><span class="line">    workbook = xlwt.Workbook()</span><br><span class="line">    <span class="comment"># 向工作簿中添加工作表</span></span><br><span class="line">    sheet = workbook.add_sheet(<span class="string">&#x27;员工详细信息&#x27;</span>)</span><br><span class="line">    <span class="comment"># 设置表头</span></span><br><span class="line">    titles = [<span class="string">&#x27;编号&#x27;</span>, <span class="string">&#x27;姓名&#x27;</span>, <span class="string">&#x27;主管&#x27;</span>, <span class="string">&#x27;职位&#x27;</span>, <span class="string">&#x27;工资&#x27;</span>, <span class="string">&#x27;部门名称&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> col, title <span class="keyword">in</span> <span class="built_in">enumerate</span>(titles):</span><br><span class="line">        sheet.write(<span class="number">0</span>, col, title, get_style(<span class="string">&#x27;HanziPenSC-W3&#x27;</span>, <span class="number">2</span>, <span class="literal">True</span>))</span><br><span class="line">    <span class="comment"># 使用Django的ORM框架查询员工数据</span></span><br><span class="line">    emps = Emp.objects.<span class="built_in">all</span>().select_related(<span class="string">&#x27;dept&#x27;</span>).select_related(<span class="string">&#x27;mgr&#x27;</span>)</span><br><span class="line">    cols = [<span class="string">&#x27;no&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;mgr&#x27;</span>, <span class="string">&#x27;job&#x27;</span>, <span class="string">&#x27;sal&#x27;</span>, <span class="string">&#x27;dept&#x27;</span>]</span><br><span class="line">    <span class="comment"># 通过嵌套的循环将员工表的数据写入Excel工作表的单元格</span></span><br><span class="line">    <span class="keyword">for</span> row, emp <span class="keyword">in</span> <span class="built_in">enumerate</span>(emps):</span><br><span class="line">        <span class="keyword">for</span> col, prop <span class="keyword">in</span> <span class="built_in">enumerate</span>(cols):</span><br><span class="line">            val = <span class="built_in">getattr</span>(emp, prop, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(val, (Dept, Emp)):</span><br><span class="line">                val = val.name</span><br><span class="line">            sheet.write(row + <span class="number">1</span>, col, val)</span><br><span class="line">    <span class="comment"># 将Excel文件的二进制数据写入内存</span></span><br><span class="line">    buffer = BytesIO()</span><br><span class="line">    workbook.save(buffer)</span><br><span class="line">    <span class="comment"># 通过HttpResponse对象向浏览器输出Excel文件</span></span><br><span class="line">    resp = HttpResponse(buffer.getvalue())</span><br><span class="line">    resp[<span class="string">&#x27;content-type&#x27;</span>] = <span class="string">&#x27;application/msexcel&#x27;</span></span><br><span class="line">    <span class="comment"># 如果文件名有中文需要处理成百分号编码</span></span><br><span class="line">    resp[<span class="string">&#x27;content-disposition&#x27;</span>] = <span class="string">&#x27;attachment; filename=&quot;detail.xls&quot;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>大文件的流式处理：<code>StreamingHttpResponse</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">request</span>):</span><br><span class="line">    file_stream = <span class="built_in">open</span>(<span class="string">&#x27;...&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">    <span class="comment"># 如果文件的二进制数据较大则最好用迭代器进行处理避免过多的占用服务器内存</span></span><br><span class="line">    file_iter = <span class="built_in">iter</span>(<span class="keyword">lambda</span>: file_stream.read(<span class="number">4096</span>), <span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">    resp = StreamingHttpResponse(file_iter)</span><br><span class="line">    <span class="comment"># 中文文件名要处理成百分号编码</span></span><br><span class="line">    filename = quote(<span class="string">&#x27;...&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    resp[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;...&#x27;</span></span><br><span class="line">    resp[<span class="string">&#x27;Content-Disposition&#x27;</span>] = <span class="string">f&#x27;attachment; filename=&quot;<span class="subst">&#123;filename&#125;</span>&quot;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：如果需要生成PDF文件，可以需要安装<code>reportlab</code>。另外，使用StreamingHttpResponse只能减少内存的开销，但是如果下载一个大文件会导致一个请求长时间占用服务器资源，比较好的做法还是把报表提前生成好（可以考虑使用定时任务），放在静态资源服务器或者是云存储服务器上以访问静态资源的方式访问。</p>
</blockquote>
</li>
<li>
<p><a target="_blank" rel="noopener" href="http://echarts.baidu.com/">ECharts</a>或<a target="_blank" rel="noopener" href="https://www.chartjs.org/">Chart.js</a>。</p>
<ul>
<li>思路：后端只提供JSON格式的数据，前端JavaScript渲染生成图表。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_charts_data</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取统计图表JSON数据&quot;&quot;&quot;</span></span><br><span class="line">    names = []</span><br><span class="line">    totals = []</span><br><span class="line">    <span class="comment"># 通过connections获取指定数据库连接并创建游标对象</span></span><br><span class="line">    <span class="keyword">with</span> connections[<span class="string">&#x27;backend&#x27;</span>].cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">        <span class="comment"># 在使用ORM框架时可以使用对象管理器的aggregate()和annotate()方法实现分组和聚合函数查询</span></span><br><span class="line">        <span class="comment"># 执行原生SQL查询(如果ORM框架不能满足业务或性能需求)</span></span><br><span class="line">        cursor.execute(<span class="string">&#x27;select dname, total from vw_dept_emp&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> cursor.fetchall():</span><br><span class="line">            names.append(row[<span class="number">0</span>])</span><br><span class="line">            totals.append(row[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;names&#x27;</span>: names, <span class="string">&#x27;totals&#x27;</span>: totals&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>统计图表<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#main</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">600px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">400px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;main&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/echarts/4.2.0-rc.2/echarts.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> myChart = echarts.<span class="title function_">init</span>($(<span class="string">&#x27;#main&#x27;</span>)[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">        $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;charts_data&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;data&#x27;</span>: &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;dataType&#x27;</span>: <span class="string">&#x27;json&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;success&#x27;</span>: <span class="keyword">function</span>(<span class="params">json</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> option = &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">title</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">text</span>: <span class="string">&#x27;员工分布统计图&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                    &#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">tooltip</span>: &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">legend</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">data</span>:[<span class="string">&#x27;人数&#x27;</span>]</span></span><br><span class="line"><span class="language-javascript">                    &#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">xAxis</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">data</span>: json.<span class="property">names</span></span></span><br><span class="line"><span class="language-javascript">                    &#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">yAxis</span>: &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">series</span>: [&#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">name</span>: <span class="string">&#x27;人数&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">type</span>: <span class="string">&#x27;bar&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">data</span>: json.<span class="property">totals</span></span></span><br><span class="line"><span class="language-javascript">                    &#125;]</span></span><br><span class="line"><span class="language-javascript">                &#125;;</span></span><br><span class="line"><span class="language-javascript">                myChart.<span class="title function_">setOption</span>(option);</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;error&#x27;</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h3 id="中间件-2">中间件</h3>
<p>问题1：中间件背后的设计理念是什么？（分离横切关注功能/拦截过滤器模式）</p>
<p>问题2：中间件有哪些不同的实现方式？（参考下面的代码）</p>
<p>问题3：描述Django内置的中间件及其执行顺序。（推荐阅读：<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/2.0/ref/middleware/#middleware-ordering">Django官方文档 - 中间件 - 中间件顺序</a>）</p>
<h4 id="激活中间件">激活中间件</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;django.middleware.security.SecurityMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions.middleware.SessionMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.common.CommonMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.csrf.CsrfViewMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth.middleware.AuthenticationMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages.middleware.MessageMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.clickjacking.XFrameOptionsMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;common.middlewares.block_sms_middleware&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="自定义中间件-2">自定义中间件</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">simple_middleware</span>(<span class="params">get_response</span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">middleware</span>(<span class="params">request, *args, **kwargs</span>):</span><br><span class="line">        </span><br><span class="line">		response = get_response(request, *args, **kwargs)</span><br><span class="line">        </span><br><span class="line">		<span class="keyword">return</span> response</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> middleware</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyMiddleware</span>:</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, get_response</span>):</span><br><span class="line">        self.get_response = get_response</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, request</span>):</span><br><span class="line">        </span><br><span class="line">        response = self.get_response(request)</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyMiddleware</span>(<span class="title class_ inherited__">MiddlewareMixin</span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_request</span>(<span class="params">request</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_view</span>(<span class="params">request, view_func, view_args, view_kwargs</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_template_response</span>(<span class="params">request, response</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_response</span>(<span class="params">request, response</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_exception</span>(<span class="params">request, exception</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h4 id="内置中间件">内置中间件</h4>
<ol>
<li>
<p>CommonMiddleware - 基础设置中间件</p>
<ul>
<li>DISALLOWED_USER_AGENTS - 不被允许的用户代理（浏览器）</li>
<li>APPEND_SLASH - 是否追加<code>/</code></li>
<li>USE_ETAG - 浏览器缓存相关</li>
</ul>
</li>
<li>
<p>SecurityMiddleware - 安全相关中间件</p>
<ul>
<li>SECURE_HSTS_SECONDS - 强制使用HTTPS的时间</li>
<li>SECURE_HSTS_INCLUDE_SUBDOMAINS - HTTPS是否覆盖子域名</li>
<li>SECURE_CONTENT_TYPE_NOSNIFF - 是否允许浏览器推断内容类型</li>
<li>SECURE_BROWSER_XSS_FILTER - 是否启用跨站脚本攻击过滤器</li>
<li>SECURE_SSL_REDIRECT - 是否重定向到HTTPS连接</li>
<li>SECURE_REDIRECT_EXEMPT - 免除重定向到HTTPS</li>
</ul>
</li>
<li>
<p>SessionMiddleware - 会话中间件</p>
</li>
<li>
<p>CsrfViewMiddleware - 防范跨站身份伪造中间件</p>
</li>
<li>
<p>XFrameOptionsMiddleware - 防范点击劫持攻击中间件</p>
<p><img src="./res/click-jacking.png" alt=""></p>
</li>
</ol>
<p><img src="./res/builtin-middlewares.png" alt=""></p>
<h3 id="表单">表单</h3>
<ol>
<li>用法：通常不要用来生成页面上的表单控件（耦合度太高不容易定制），主要用来验证数据。</li>
<li>Form的属性和方法：
<ul>
<li><code>is_valid()</code> / <code>is_multipart()</code></li>
<li><code>errors</code> / <code>fields</code> / <code>is_bound</code> / <code>changed_data</code> / <code>cleaned_data</code></li>
<li><code>add_error()</code> / <code>has_errors()</code> / <code>non_field_errors()</code></li>
<li><code>clean()</code></li>
</ul>
</li>
<li>Form.errors的方法：
<ul>
<li><code>as_data()</code> / <code>as_json()</code> / <code>get_json_data()</code></li>
</ul>
</li>
</ol>
<p>问题1：Django中的<code>Form</code>和<code>ModelForm</code>有什么作用？（通常不用来生成表单主要用来验证数据）</p>
<p>问题2：表单上传文件时应该注意哪些问题？（表单的设置、多文件上传、图片预览（FileReader）、Ajax上传文件、上传后的文件如何存储、调用云存储（如<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss">阿里云OSS</a>、<a target="_blank" rel="noopener" href="https://www.qiniu.com/">七牛云</a>、<a target="_blank" rel="noopener" href="https://leancloud.cn/storage/">LeanCloud</a>等））</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;...&quot;</span> <span class="attr">multiple</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;foo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;foo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;foo&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：上传图片文件的预览效果可以通过HTML5的FileReader来实现。</p>
</blockquote>
<blockquote>
<p>说明：使用云存储通常是比自己配置分布式文件系统这种方式更靠谱的做法，而且云存储通常成本并不太高，不仅如此大多数云存储还提供了如图片剪裁、生成水印、视频转码、CDN等服务。如果要自己做上传的视频文件转码，需要安装三方库ffmpeg，在程序中调用该三方库可以实现转码。</p>
</blockquote>
<h3 id="Cookie和Session-2">Cookie和Session</h3>
<p>问题1：使用Cookie能解决什么问题？（用户跟踪，解决HTTP协议无状态问题）</p>
<ol>
<li>
<p>URL重写</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://www.abc.com/path/resource?foo=bar</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>隐藏域（隐式表单域）- 埋点</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;foo&quot;</span> <span class="attr">value</span>=<span class="string">&quot;bar&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Cookie - 浏览器中的临时文件（文本文件）- BASE64</p>
</li>
</ol>
<p>问题2：Cookie和Session之间关系是什么？（Session的标识通过Cookie保存和传输）</p>
<h4 id="Session的配置">Session的配置</h4>
<ol>
<li>
<p>Session对应的中间件：<code>django.contrib.sessions.middleware.SessionMiddleware</code>。</p>
</li>
<li>
<p>Session引擎。</p>
<ul>
<li>
<p>基于数据库（默认方式）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>基于缓存（推荐使用）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.cache&#x27;</span></span><br><span class="line">SESSION_CACHE_ALIAS = <span class="string">&#x27;session&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>基于文件（基本不考虑）</p>
</li>
<li>
<p>基于Cookie（不靠谱）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.signed_cookies&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>Cookie相关的配置。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SESSION_COOKIE_NAME = <span class="string">&#x27;djang_session_id&#x27;</span></span><br><span class="line">SESSION_COOKIE_AGE = <span class="number">1209600</span></span><br><span class="line"><span class="comment"># 如果设置为True，Cookie就是基于浏览器窗口的Cookie，不会持久化</span></span><br><span class="line">SESSION_EXPIRE_AT_BROWSER_CLOSE = <span class="literal">False</span> </span><br><span class="line">SESSION_SAVE_EVERY_REQUEST = <span class="literal">False</span></span><br><span class="line">SESSION_COOKIE_HTTPONLY = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>session的属性和方法。</p>
<ul>
<li><code>session_key</code> / <code>session_data</code> / <code>expire_date</code></li>
<li><code>__getitem__</code> / <code>__setitem__</code> / <code>__delitem__</code> / <code>__contains__</code></li>
<li><code>set_expiry()</code> / <code>get_expiry_age()</code> / <code>get_expiry_date()</code> - 设置/获取会话超期时间</li>
<li><code>flush()</code> - 销毁会话</li>
<li><code>set_test_cookie()</code> / <code>test_cookie_worked()</code> / <code>delete_test_cookie()</code> - 测试浏览器是否支持Cookie（提示用户如果浏览器禁用Cookie可能会影响网站的使用）</li>
</ul>
</li>
<li>
<p>session的序列化。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SESSION_SERIALIZER = <span class="string">&#x27;django.contrib.sessions.serializers.JSONSerializer&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>JSONSerializer（1.6及以后默认）- 如果想将自定义的对象放到session中，会遇到“Object of type ‘XXX’ is not JSON serializable”的问题（如果配置使用Redis保存Session，django-redis使用了Pickle序列化，这个问题就不存在了）。</p>
</li>
<li>
<p>PickleSerializer（1.6以前的默认）- 因为安全问题不推荐使用，但是只要不去反序列化用户构造的恶意的Payload其实也没有什么风险。关于这种方式的安全漏洞，可以参考《<a target="_blank" rel="noopener" href="http://www.polaris-lab.com/index.php/archives/178/">Python Pickle的任意代码执行漏洞实践和Payload构造》</a>一文或《软件架构-Python语言实现》上关于这个问题的讲解。</p>
<blockquote>
<p>说明：如果使用了django_redis整合Redis作为session的存储引擎，那么由于django_redis又封装了一个PickleSerializer来提供序列化，所以不会存在上述的问题，且Redis中保存的value是pickle序列化之后的结果。</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<h3 id="缓存">缓存</h3>
<h4 id="配置缓存">配置缓存</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="comment"># 默认缓存</span></span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django_redis.cache.RedisCache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;LOCATION&#x27;</span>: [</span><br><span class="line">            <span class="string">&#x27;redis://1.2.3.4:6379/0&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;KEY_PREFIX&#x27;</span>: <span class="string">&#x27;teamproject&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="string">&#x27;django_redis.client.DefaultClient&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;max_connections&#x27;</span>: <span class="number">1000</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;yourpass&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 页面缓存</span></span><br><span class="line">    <span class="string">&#x27;page&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django_redis.cache.RedisCache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;LOCATION&#x27;</span>: [</span><br><span class="line">            <span class="string">&#x27;redis://1.2.3.4:6379/1&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;KEY_PREFIX&#x27;</span>: <span class="string">&#x27;teamproject:page&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="string">&#x27;django_redis.client.DefaultClient&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;max_connections&#x27;</span>: <span class="number">500</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;yourpass&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 会话缓存</span></span><br><span class="line">    <span class="string">&#x27;session&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django_redis.cache.RedisCache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;LOCATION&#x27;</span>: [</span><br><span class="line">            <span class="string">&#x27;redis://1.2.3.4:6379/2&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;KEY_PREFIX&#x27;</span>: <span class="string">&#x27;teamproject:session&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;TIMEOUT&#x27;</span>: <span class="number">1209600</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="string">&#x27;django_redis.client.DefaultClient&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;max_connections&#x27;</span>: <span class="number">2000</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;yourpass&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 接口数据缓存</span></span><br><span class="line">    <span class="string">&#x27;api&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django_redis.cache.RedisCache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;LOCATION&#x27;</span>: [</span><br><span class="line">            <span class="string">&#x27;redis://1.2.3.4:6379/3&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;KEY_PREFIX&#x27;</span>: <span class="string">&#x27;teamproject:api&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="string">&#x27;django_redis.client.DefaultClient&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;CONNECTION_POOL_KWARGS&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;max_connections&#x27;</span>: <span class="number">500</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;yourpass&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：通过Redis底层提供的多个数据库来隔离缓存数据有助于缓存数据的管理。如果配置了Redis的主从复制（读写分离），LOCATION列表中可以配置多个Redis连接，第一个被视为master用来进行写操作，后面的被视为slave用来进行读操作。</p>
</blockquote>
<h4 id="全站缓存">全站缓存</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">MIDDLEWARE_CLASSES = [</span><br><span class="line">    <span class="string">&#x27;django.middleware.cache.UpdateCacheMiddleware&#x27;</span>,</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;django.middleware.common.CommonMiddleware&#x27;</span>,</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;django.middleware.cache.FetchFromCacheMiddleware&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">CACHE_MIDDLEWARE_ALIAS = <span class="string">&#x27;default&#x27;</span></span><br><span class="line">CACHE_MIDDLEWARE_SECONDS = <span class="number">300</span></span><br><span class="line">CACHE_MIDDLEWARE_KEY_PREFIX = <span class="string">&#x27;djang:cache&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="视图层缓存">视图层缓存</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.vary <span class="keyword">import</span> vary_on_cookie</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cache_page(<span class="params">timeout=<span class="number">60</span> * <span class="number">15</span>, cache=<span class="string">&#x27;page&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@vary_on_cookie</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_view</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^foo/([0-9]&#123;1,2&#125;)/$&#x27;</span>, cache_page(<span class="number">60</span> * <span class="number">15</span>)(my_view)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="其他内容-4">其他内容</h4>
<ol>
<li>
<p>模板片段缓存。</p>
<ul>
<li><code>&#123;% load cache %&#125;</code></li>
<li><code>&#123;% cache %&#125;` / `&#123;% endcache %&#125;</code></li>
</ul>
</li>
<li>
<p>使用底层API访问缓存。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache.<span class="built_in">set</span>(<span class="string">&#x27;my_key&#x27;</span>, <span class="string">&#x27;hello, world!&#x27;</span>, <span class="number">30</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache.get(<span class="string">&#x27;my_key&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache.clear()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> caches</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache1 = caches[<span class="string">&#x27;page&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache2 = caches[<span class="string">&#x27;page&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache1 <span class="keyword">is</span> cache2</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache3 = caches[<span class="string">&#x27;session&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache2 <span class="keyword">is</span> cache3</span><br><span class="line"><span class="literal">False</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django_redis <span class="keyword">import</span> get_redis_connection</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>redis_client = get_redis_connection()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>redis_client.hgetall()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="日志">日志</h3>
<h4 id="日志级别">日志级别</h4>
<p>NOTSET &lt; DEBUG &lt; INFO &lt; WARNING &lt; ERROR &lt; CRITICAL</p>
<h4 id="日志配置">日志配置</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="comment"># 配置日志格式化器</span></span><br><span class="line">    <span class="string">&#x27;formatters&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;simple&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(asctime)s %(module)s.%(funcName)s: %(message)s&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;datefmt&#x27;</span>: <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;verbose&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(asctime)s %(levelname)s [%(process)d-%(threadName)s] &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;%(module)s.%(funcName)s line %(lineno)d: %(message)s&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;datefmt&#x27;</span>: <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 配置日志过滤器</span></span><br><span class="line">    <span class="string">&#x27;filters&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;require_debug_true&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;()&#x27;</span>: <span class="string">&#x27;django.utils.log.RequireDebugTrue&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 配置日志处理器</span></span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;console&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;filters&#x27;</span>: [<span class="string">&#x27;require_debug_true&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;simple&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;file1&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.handlers.TimedRotatingFileHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;access.log&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;when&#x27;</span>: <span class="string">&#x27;W0&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;backupCount&#x27;</span>: <span class="number">12</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;simple&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;file2&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.handlers.TimedRotatingFileHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;error.log&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;when&#x27;</span>: <span class="string">&#x27;D&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;backupCount&#x27;</span>: <span class="number">31</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;verbose&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;WARNING&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 配置日志器</span></span><br><span class="line">    <span class="string">&#x27;loggers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;django&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>, <span class="string">&#x27;file1&#x27;</span>, <span class="string">&#x27;file2&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/2.0/topics/logging/#s-examples">日志配置官方示例</a>。</p>
<h4 id="日志分析">日志分析</h4>
<ol>
<li>
<p>Linux相关命令：head、tail、grep、awk、uniq、sort</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tail -10000 access.log | awk &#x27;&#123;print $1&#125;&#x27; | uniq -c | sort -r</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实时日志文件分析：Python + 正则表达式 + Crontab</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/jkklee/web_log_analyse">《Python日志分析工具》</a>。</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/opensource/os-cn-elk/index.html">《集中式日志系统ELK》</a>。</p>
<ul>
<li>ElasticSearch：搜索引擎，实现全文检索。</li>
<li>Logstash：负责从指定节点收集日志。</li>
<li>Kibana：日志可视化工具。</li>
</ul>
</li>
<li>
<p>大数据日志处理：Flume+Kafka日志采集、Storm / Spark实时数据处理、Impala实时查询。</p>
</li>
</ol>
<h3 id="RESTful">RESTful</h3>
<p>问题1：RESTful架构到底解决了什么问题？（URL具有自描述性、资源表述与视图的解耦和、互操作性利用构建微服务以及集成第三方系统、无状态性提高水平扩展能力）</p>
<p>问题2：项目在使用RESTful架构时有没有遇到一些问题或隐患？（对资源访问的限制、资源从属关系检查、避免泄露业务信息、防范可能的攻击）</p>
<blockquote>
<p>补充：下面的几个和安全性相关的响应头在前面讲中间件的时候提到过的。</p>
<ul>
<li>X-Frame-Options: DENY</li>
<li>X-Content-Type-Options: nosniff</li>
<li>X-XSS-Protection: 1; mode=block;</li>
<li>Strict­-Transport-­Security: max-age=31536000;</li>
</ul>
</blockquote>
<p>问题3：如何保护API中的敏感信息以及防范重放攻击？（摘要和令牌）</p>
<p>推荐阅读：<a target="_blank" rel="noopener" href="https://help.aliyun.com/knowledge_detail/50041.html">《如何有效防止API的重放攻击》</a>。</p>
<h4 id="使用djangorestframework">使用djangorestframework</h4>
<p>安装djangorestfrmework（为了描述方便，以下统一简称为DRF）。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install djangorestframework</span><br></pre></td></tr></table></figure>
<p>配置DRF。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    </span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 配置默认页面大小</span></span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="comment"># 配置默认的分页类</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.pagination.PageNumberPagination&#x27;</span>,</span><br><span class="line">    <span class="comment"># 配置异常处理器</span></span><br><span class="line">    <span class="comment"># &#x27;EXCEPTION_HANDLER&#x27;: &#x27;api.exceptions.exception_handler&#x27;,</span></span><br><span class="line">    <span class="comment"># 配置默认解析器</span></span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_PARSER_CLASSES&#x27;: (</span></span><br><span class="line">    <span class="comment">#     &#x27;rest_framework.parsers.JSONParser&#x27;,</span></span><br><span class="line">    <span class="comment">#     &#x27;rest_framework.parsers.FormParser&#x27;,</span></span><br><span class="line">    <span class="comment">#     &#x27;rest_framework.parsers.MultiPartParser&#x27;,</span></span><br><span class="line">    <span class="comment"># ),</span></span><br><span class="line">    <span class="comment"># 配置默认限流类</span></span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_THROTTLE_CLASSES&#x27;: (),</span></span><br><span class="line">    <span class="comment"># 配置默认授权类</span></span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_PERMISSION_CLASSES&#x27;: (</span></span><br><span class="line">    <span class="comment">#     &#x27;rest_framework.permissions.IsAuthenticated&#x27;,</span></span><br><span class="line">    <span class="comment"># ),</span></span><br><span class="line">    <span class="comment"># 配置默认认证类</span></span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;: (</span></span><br><span class="line">    <span class="comment">#     &#x27;rest_framework_jwt.authentication.JSONWebTokenAuthentication&#x27;,</span></span><br><span class="line">    <span class="comment"># ),</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="编写序列化器-2">编写序列化器</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.serializers <span class="keyword">import</span> ModelSerializer</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> common.models <span class="keyword">import</span> District, HouseType, Estate, Agent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DistrictSerializer</span>(<span class="title class_ inherited__">ModelSerializer</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = District</span><br><span class="line">        fields = (<span class="string">&#x27;distid&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HouseTypeSerializer</span>(<span class="title class_ inherited__">ModelSerializer</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = HouseType</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentSerializer</span>(<span class="title class_ inherited__">ModelSerializer</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Agent</span><br><span class="line">        fields = (<span class="string">&#x27;agentid&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;tel&#x27;</span>, <span class="string">&#x27;servstar&#x27;</span>, <span class="string">&#x27;certificated&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EstateSerializer</span>(<span class="title class_ inherited__">ModelSerializer</span>):</span><br><span class="line">    district = serializers.SerializerMethodField()</span><br><span class="line">    agents = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_agents</span>(<span class="params">estate</span>):</span><br><span class="line">        <span class="keyword">return</span> AgentSerializer(estate.agents, many=<span class="literal">True</span>).data</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_district</span>(<span class="params">estate</span>):</span><br><span class="line">        <span class="keyword">return</span> DistrictSerializer(estate.district).data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Estate</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="方法1：使用装饰器">方法1：使用装饰器</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@cache_page(<span class="params">timeout=<span class="literal">None</span>, cache=<span class="string">&#x27;api&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">provinces</span>(<span class="params">request</span>):</span><br><span class="line">    queryset = District.objects.<span class="built_in">filter</span>(parent__isnull=<span class="literal">True</span>)</span><br><span class="line">    serializer = DistrictSerializer(queryset, many=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@cache_page(<span class="params">timeout=<span class="number">300</span>, cache=<span class="string">&#x27;api&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cities</span>(<span class="params">request, provid</span>):</span><br><span class="line">    queryset = District.objects.<span class="built_in">filter</span>(parent__distid=provid)</span><br><span class="line">    serializer = DistrictSerializer(queryset, many=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;districts/&#x27;</span>, views.provinces, name=<span class="string">&#x27;districts&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;districts/&lt;int:provid&gt;/&#x27;</span>, views.cities, name=<span class="string">&#x27;cities&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：上面使用了Django自带的视图装饰器（@cache_page）来实现对API接口返回数据的缓存。</p>
</blockquote>
<h4 id="方法2：使用APIView及其子类">方法2：使用APIView及其子类</h4>
<p>更好的复用代码，不要重“复发明轮子”。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HouseTypeApiView</span>(CacheResponseMixin, ListAPIView):</span><br><span class="line">    queryset = HouseType.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = HouseTypeSerializer</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;housetypes/&#x27;</span>, views.HouseTypeApiView.as_view(), name=<span class="string">&#x27;housetypes&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：上面使用了drf_extensions提供的CacheResponseMixin混入类实现了对接口数据的缓存。如果重写了获取数据的方法，可以使用drf_extensions提供的@cache_response来实现对接口数据的缓存，也可以用自定义的函数来生成缓存中的key。当然还有一个选择就是通过Django提供的@method_decorator装饰器，将@cache_page装饰器处理为装饰方法的装饰器，这样也能提供使用缓存服务。</p>
</blockquote>
<p><code>drf-extensions</code>配置如下所示。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置DRF扩展来支持缓存API接口调用结果</span></span><br><span class="line">REST_FRAMEWORK_EXTENSIONS = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_CACHE_RESPONSE_TIMEOUT&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">    <span class="string">&#x27;DEFAULT_USE_CACHE&#x27;</span>: <span class="string">&#x27;default&#x27;</span>,</span><br><span class="line">    <span class="comment"># 配置默认缓存单个对象的key函数</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_OBJECT_CACHE_KEY_FUNC&#x27;</span>: <span class="string">&#x27;rest_framework_extensions.utils.default_object_cache_key_func&#x27;</span>,</span><br><span class="line">    <span class="comment"># 配置默认缓存对象列表的key函数</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_LIST_CACHE_KEY_FUNC&#x27;</span>: <span class="string">&#x27;rest_framework_extensions.utils.default_list_cache_key_func&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="方法3：使用ViewSet及其子类">方法3：使用ViewSet及其子类</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HouseTypeViewSet</span>(CacheResponseMixin, viewsets.ModelViewSet):</span><br><span class="line">    queryset = HouseType.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = HouseTypeSerializer</span><br><span class="line">    pagination_class = <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">&#x27;housetypes&#x27;</span>, views.HouseTypeViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns += router.urls</span><br></pre></td></tr></table></figure>
<p>djangorestframework提供了基于Bootstrap定制的页面来显示接口返回的JSON数据，当然也可以使用<a target="_blank" rel="noopener" href="https://www.getpostman.com/">POSTMAN</a>这样的工具对API接口进行测试。</p>
<h4 id="补充说明-512">补充说明</h4>
<p>在这里顺便提一下跟前端相关的几个问题。</p>
<p>问题1：如何让浏览器能够发起DELETE/PUT/PATCH？</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">value</span>=<span class="string">&quot;delete&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;_method&#x27;</span> <span class="keyword">in</span> request.POST:</span><br><span class="line">    request.method = request.POST[<span class="string">&#x27;_method&#x27;</span>].upper()</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;/api/provinces&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;put&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;data&#x27;</span>: &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;dataType&#x27;</span>: <span class="string">&#x27;json&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;success&#x27;</span>: <span class="keyword">function</span>(<span class="params">json</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// Web = 标签(内容) + CSS(显示) + JS(行为)</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// JavaScript = ES + BOM + DOM</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// DOM操作实现页面的局部刷新</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;error&#x27;</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    $.<span class="title function_">getJSON</span>(<span class="string">&#x27;/api/provinces&#x27;</span>, <span class="keyword">function</span>(<span class="params">json</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// DOM操作实现页面的局部刷新</span></span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>问题2：如何解决多个JavaScript库之间某个定义（如$函数）冲突的问题？</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/abc.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// $已经被后加载的JavaScript库占用了</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 但是可以直接用绑定在window对象上的jQuery去代替$</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">jQuery</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">jQuery</span>(<span class="string">&#x27;#okBtn&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/abc.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 将$让出给其他的JavaScript库使用</span></span></span><br><span class="line"><span class="language-javascript">	jQuery.<span class="title function_">noConflict</span>();</span></span><br><span class="line"><span class="language-javascript">	<span class="title function_">jQuery</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">jQuery</span>(<span class="string">&#x27;#okBtn&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>问题3：jQuery对象与原生DOM对象之间如何转换？</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;okBtn&quot;</span>&gt;</span>点我<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;okBtn&#x27;</span>);	<span class="comment">// 原生JavaScript对象(使用相对麻烦)</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> $btn = $(<span class="string">&#x27;#okBtn&#x27;</span>);	<span class="comment">// jQuery对象(拥有更多的属性和方法而且没有浏览器兼容性问题)</span></span></span><br><span class="line"><span class="language-javascript">    $btn.<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// $(btn)可以将原生JavaScript对象转成jQuery对象</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// $btn.get(0)或$btn[0]可以获得原生的JavaScript对象</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="过滤数据">过滤数据</h4>
<p>如果需要过滤数据（对数据接口设置筛选条件、排序条件等），可以使用<code>django-filter</code>三方库来实现。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install django-filter</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    </span><br><span class="line">    <span class="string">&#x27;django_filters&#x27;</span>,</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">  	</span><br><span class="line">    <span class="string">&#x27;DEFAULT_FILTER_BACKENDS&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;django_filters.rest_framework.DjangoFilterBackend&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.filters.OrderingFilter&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"><span class="keyword">from</span> rest_framework.filters <span class="keyword">import</span> OrderingFilter</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> RetrieveAPIView, ListCreateAPIView</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> api.serializers <span class="keyword">import</span> EstateSerializer</span><br><span class="line"><span class="keyword">from</span> common.models <span class="keyword">import</span> Estate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@method_decorator(<span class="params">decorator=cache_page(<span class="params">timeout=<span class="number">120</span>, cache=<span class="string">&#x27;api&#x27;</span>, key_prefix=<span class="string">&#x27;estates&#x27;</span></span>), name=<span class="string">&#x27;get&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EstateView</span>(RetrieveAPIView, ListCreateAPIView):</span><br><span class="line">    queryset = Estate.objects.<span class="built_in">all</span>().select_related(<span class="string">&#x27;district&#x27;</span>).prefetch_related(<span class="string">&#x27;agents&#x27;</span>)</span><br><span class="line">    serializer_class = EstateSerializer</span><br><span class="line">    filter_backends = (DjangoFilterBackend, OrderingFilter)</span><br><span class="line">    filter_fields = (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;district&#x27;</span>)</span><br><span class="line">    ordering = (<span class="string">&#x27;-hot&#x27;</span>, )</span><br><span class="line">    ordering_fields = (<span class="string">&#x27;hot&#x27;</span>, <span class="string">&#x27;estateid&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django_filters <span class="keyword">import</span> rest_framework <span class="keyword">as</span> drf</span><br><span class="line"><span class="keyword">from</span> common.models <span class="keyword">import</span> HouseInfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HouseInfoFilter</span>(drf.FilterSet):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;自定义房源数据过滤器&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    title = drf.CharFilter(lookup_expr=<span class="string">&#x27;starts&#x27;</span>)</span><br><span class="line">    dist = drf.NumberFilter(field_name=<span class="string">&#x27;district&#x27;</span>)</span><br><span class="line">    min_price = drf.NumberFilter(field_name=<span class="string">&#x27;price&#x27;</span>, lookup_expr=<span class="string">&#x27;gte&#x27;</span>)</span><br><span class="line">    max_price = drf.NumberFilter(field_name=<span class="string">&#x27;price&#x27;</span>, lookup_expr=<span class="string">&#x27;lte&#x27;</span>)</span><br><span class="line">    <span class="built_in">type</span> = drf.NumberFilter()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = HouseInfo</span><br><span class="line">        fields = (<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;district&#x27;</span>, <span class="string">&#x27;min_price&#x27;</span>, <span class="string">&#x27;max_price&#x27;</span>, <span class="string">&#x27;type&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HouseInfoViewSet</span>(CacheResponseMixin, ReadOnlyModelViewSet):</span><br><span class="line">    queryset = HouseInfo.objects.<span class="built_in">all</span>() \</span><br><span class="line">        .select_related(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;district&#x27;</span>, <span class="string">&#x27;estate&#x27;</span>, <span class="string">&#x27;agent&#x27;</span>) \</span><br><span class="line">        .prefetch_related(<span class="string">&#x27;tags&#x27;</span>).order_by(<span class="string">&#x27;-pubdate&#x27;</span>)</span><br><span class="line">    serializer_class = HouseInfoSerializer</span><br><span class="line">    filter_backends = (DjangoFilterBackend, OrderingFilter)</span><br><span class="line">    filterset_class = HouseInfoFilter</span><br><span class="line">    ordering = (<span class="string">&#x27;price&#x27;</span>,)</span><br><span class="line">    ordering_fields = (<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;area&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="身份认证">身份认证</h4>
<p>查看DRF中APIView类的代码可以看出，DRF默认的认证方案是 <code>DEFAULT_AUTHENTICATION_CLASSES</code>，如果修改authentication_classes就可以自行定制身份认证的方案。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">APIView</span>(<span class="title class_ inherited__">View</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The following policies may be set at either globally, or per-view.</span></span><br><span class="line">    renderer_classes = api_settings.DEFAULT_RENDERER_CLASSES</span><br><span class="line">    parser_classes = api_settings.DEFAULT_PARSER_CLASSES</span><br><span class="line">    authentication_classes = api_settings.DEFAULT_AUTHENTICATION_CLASSES</span><br><span class="line">    throttle_classes = api_settings.DEFAULT_THROTTLE_CLASSES</span><br><span class="line">    permission_classes = api_settings.DEFAULT_PERMISSION_CLASSES</span><br><span class="line">    content_negotiation_class = api_settings.DEFAULT_CONTENT_NEGOTIATION_CLASS</span><br><span class="line">    metadata_class = api_settings.DEFAULT_METADATA_CLASS</span><br><span class="line">    versioning_class = api_settings.DEFAULT_VERSIONING_CLASS</span><br><span class="line"></span><br><span class="line">   	<span class="comment"># 此处省略下面的代码</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DEFAULTS = &#123;</span><br><span class="line">    <span class="comment"># Base API policies</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_RENDERER_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.renderers.JSONRenderer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.renderers.BrowsableAPIRenderer&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PARSER_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.JSONParser&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.FormParser&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.MultiPartParser&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.SessionAuthentication&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.BasicAuthentication&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.AllowAny&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_CONTENT_NEGOTIATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.negotiation.DefaultContentNegotiation&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DEFAULT_METADATA_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.metadata.SimpleMetadata&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DEFAULT_VERSIONING_CLASS&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 此处省略下面的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义认证类，继承<code>BaseAuthentication</code>并重写<code>authenticate(self, request)</code>方法，通过请求中的userid和token来确定用户身份。如果认证成功，该方法应返回一个二元组（用户和令牌的信息），否则产生异常。也可以重写 <code>authenticate_header(self, request)</code>方法来返回一个字符串，该字符串将用于<code>HTTP 401 Unauthorized</code>响应中的WWW-Authenticate响应头的值。如果未重写该方法，那么当未经身份验证的请求被拒绝访问时，身份验证方案将返回<code>HTTP 403 Forbidden</code>响应。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyAuthentication</span>(<span class="title class_ inherited__">BaseAuthentication</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;自定义用户身份认证类&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            token = request.GET[<span class="string">&#x27;token&#x27;</span>] <span class="keyword">or</span> request.POST[<span class="string">&#x27;token&#x27;</span>]</span><br><span class="line">            user_token = UserToken.objects.<span class="built_in">filter</span>(token=token).first()</span><br><span class="line">            <span class="keyword">if</span> user_token:</span><br><span class="line">                <span class="keyword">return</span> user_token.user, user_token</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;请提供有效的用户身份标识&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;请提供有效的用户身份标识&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate_header</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>使用自定义的认证类。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EstateViewSet</span>(CacheResponseMixin, ModelViewSet):</span><br><span class="line">    <span class="comment"># 通过queryset指定如何获取数据（资源）</span></span><br><span class="line">    queryset = Estate.objects.<span class="built_in">all</span>().select_related(<span class="string">&#x27;district&#x27;</span>).prefetch_related(<span class="string">&#x27;agents&#x27;</span>)</span><br><span class="line">    <span class="comment"># 通过serializer_class指定如何序列化数据</span></span><br><span class="line">    serializer_class = EstateSerializer</span><br><span class="line">    <span class="comment"># 指定根据哪些字段进行数据筛选</span></span><br><span class="line">    filter_fields = (<span class="string">&#x27;district&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    <span class="comment"># 指定根据哪些字段对数据进行排序</span></span><br><span class="line">    ordering_fields = (<span class="string">&#x27;hot&#x27;</span>, )</span><br><span class="line">    <span class="comment"># 指定用于进行用户身份验证的类</span></span><br><span class="line">    authentication_classes = (MyAuthentication, )</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：也可以在Django配置文件中将自定义的认证类设置为默认认证方式。</p>
</blockquote>
<h4 id="授予权限">授予权限</h4>
<p>权限检查总是在视图的最开始处运行，在任何其他代码被允许进行之前。最简单的权限是允许通过身份验证的用户访问，并拒绝未经身份验证的用户访问，这对应于dfr中的<code>IsAuthenticated</code>类，可以用它来取代默认的<code>AllowAny</code>类。权限策略可以在Django的DRF配置中用<code>DEFAULT_PERMISSION_CLASSES</code>全局设置。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.IsAuthenticated&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以在基于<code>APIView</code>类的视图上设置身份验证策略。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    permission_classes = (IsAuthenticated, )</span><br><span class="line">    <span class="comment"># 此处省略其他代码</span></span><br></pre></td></tr></table></figure>
<p>或者在基于<code>@api_view</code>装饰器的视图函数上设置。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view, permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@permission_classes(<span class="params">(<span class="params">IsAuthenticated, </span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">example_view</span>(<span class="params">request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># 此处省略其他代码</span></span><br></pre></td></tr></table></figure>
<p>自定义权限需要继承<code>BasePermission</code>并实现以下方法中的一个或两个，下面是BasePermission的代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@six.add_metaclass(<span class="params">BasePermissionMetaclass</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BasePermission</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A base class from which all permission classes should inherit.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">has_permission</span>(<span class="params">self, request, view</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Return `True` if permission is granted, `False` otherwise.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">has_object_permission</span>(<span class="params">self, request, view, obj</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Return `True` if permission is granted, `False` otherwise.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>如果请求被授予访问权限，则方法应该返回True，否则返False。下面的例子演示了阻止黑名单中的IP地址访问接口数据（这个在反爬虫的时候很有用哟）。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlacklistPermission</span>(permissions.BasePermission):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Global permission check for blacklisted IPs.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">has_permission</span>(<span class="params">self, request, view</span>):</span><br><span class="line">        ip_addr = request.META[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]</span><br><span class="line">        blacklisted = Blacklist.objects.<span class="built_in">filter</span>(ip_addr=ip_addr).exists()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> blacklisted</span><br></pre></td></tr></table></figure>
<p>如果要实现更为完整的权限验证，可以考虑RBAC或ACL。</p>
<ol>
<li>
<p>RBAC - 基于角色的访问控制，如下图所示。</p>
<p><img src="./res/rbac-basic.png" alt=""></p>
<p><img src="./res/rbac-full.png" alt=""></p>
</li>
<li>
<p>ACL - 访问控制列表（每个用户绑定自己的访问白名单或黑名单）。</p>
</li>
</ol>
<h4 id="访问限流">访问限流</h4>
<p>可以修改dfr配置的<code>DEFAULT_THROTTLE_CLASSES</code> 和 <code>DEFAULT_THROTTLE_RATES</code>两个值来设置全局默认限流策略。例如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;3/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;10000/day&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>DEFAULT_THROTTLE_RATES</code>中使用的频率描述可能包括<code>second</code>、<code>minute</code>、<code>hour</code>或<code>day</code>。</p>
<p>如果要为接口单独设置限流，可以在每个视图或视图集上设置限流策略，如下所示：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> UserRateThrottle</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    throttle_classes = (UserRateThrottle, )</span><br><span class="line">    <span class="comment"># 此处省略下面的代码</span></span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@throttle_classes(<span class="params">[UserRateThrottle, ]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">example_view</span>(<span class="params">request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># 此处省略下面的代码</span></span><br></pre></td></tr></table></figure>
<p>当然也可以通过继承<code>SimpleRateThrottle</code>来自定义限流策略，通常需要重写<code>allow_request</code>和<code>wait</code>方法。</p>
<h3 id="异步任务和计划任务">异步任务和计划任务</h3>
<h4 id="Celery的应用">Celery的应用</h4>
<p>Celery 是一个简单、灵活且可靠的，处理大量消息的分布式系统，并且提供维护这样一个系统的必需工具。它是一个专注于实时处理的任务队列，同时也支持任务调度。</p>
<p>推荐阅读：<a target="_blank" rel="noopener" href="http://docs.jinkan.org/docs/celery/">《Celery官方文档中文版》</a>，上面有极为详细的配置和使用指南。</p>
<p><img src="./res/celery_architecture.png" alt=""></p>
<p>Celery是一个本身不提供队列服务，官方推荐使用RabbitMQ或Redis来实现消息队列服务，前者是更好的选择，它对AMQP（高级消息队列协议）做出了非常好的实现。</p>
<ol>
<li>
<p>安装RabbitMQ。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull rabbitmq</span><br><span class="line">docker run -d -p 5672:5672 --name myrabbit rabbitmq</span><br><span class="line">docker container exec -it myrabbit /bin/bash</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建用户、资源以及分配操作权限。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rabbitmqctl add_user luohao 123456</span><br><span class="line">rabbitmqctl set_user_tags luohao administrator</span><br><span class="line">rabbitmqctl add_vhost vhost1</span><br><span class="line">rabbitmqctl set_permissions -p vhost1 luohao &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建Celery实例。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 注册环境变量</span></span><br><span class="line">os.environ.setdefault(<span class="string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="string">&#x27;项目名.settings&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Celery实例</span></span><br><span class="line">app = celery.Celery(</span><br><span class="line">    <span class="string">&#x27;fangtx&#x27;</span>,</span><br><span class="line">    broker=<span class="string">&#x27;amqp://luohao:123456@1.2.3.4:5672/vhost1&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从项目的配置文件读取Celery配置信息</span></span><br><span class="line"><span class="comment"># app.config_from_object(&#x27;django.conf:settings&#x27;)</span></span><br><span class="line"><span class="comment"># 从指定的文件(例如celery_config.py)中读取Celery配置信息</span></span><br><span class="line"><span class="comment"># app.config_from_object(&#x27;celery_config&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 让Celery自动从参数指定的应用中发现异步任务/定时任务</span></span><br><span class="line"><span class="comment"># app.autodiscover_tasks([&#x27;common&#x27;, ])</span></span><br><span class="line"><span class="comment"># 让Celery自动从所有注册的应用中发现异步任务/定时任务</span></span><br><span class="line">app.autodiscover_tasks(<span class="keyword">lambda</span>: settings.INSTALLED_APPS)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>启动Celery创建woker（消息的消费者）。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">celery -A &lt;name&gt; worker -l debug &amp;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>执行异步任务。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_email</span>(<span class="params">from_user, to_user, cc_user, subject, content</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 消息的生产者</span></span><br><span class="line">send_email.delay(<span class="string">&#x27;&#x27;</span>, [], [], <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建定时任务。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置定时任务（计划任务）</span></span><br><span class="line">app.conf.update(</span><br><span class="line">    timezone=settings.TIME_ZONE,</span><br><span class="line">    enable_utc=<span class="literal">True</span>,</span><br><span class="line">    <span class="comment"># 定时任务（计划任务）相当于是消息的生产者</span></span><br><span class="line">    <span class="comment"># 如果只有生产者没有消费者那么消息就会在消息队列中积压</span></span><br><span class="line">    <span class="comment"># 将来实际部署项目的时候生产者、消费者、消息队列可能都是不同节点</span></span><br><span class="line">    beat_schedule=&#123;</span><br><span class="line">        <span class="string">&#x27;task1&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;common.tasks.scheduled_task&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;schedule&#x27;</span>: crontab(<span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;*&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;args&#x27;</span>: (<span class="string">&#x27;...&#x27;</span>, )</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scheduled_task</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>启动Celery创建执行定时任务的beat（消息的生产者）。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">celery -A &lt;name&gt; beat -l info</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>检查消息队列状况。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rabbitmqctl list_queues -p vhost1</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>监控Celery - 可以通过flower来对Celery进行监控。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install flower</span><br><span class="line">celery flower --broker=amqp://luohao:123456@120.77.222.217:5672/vhost1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="其他问题-2">其他问题</h3>
<p>问题1：如何解决JavaScript跨域获取数据的问题？（django-cors-headers）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;corsheaders&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;corsheaders.middleware.CorsMiddleware&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">CORS_ORIGIN_ALLOW_ALL = <span class="literal">True</span></span><br><span class="line"><span class="comment"># 配置跨域白名单</span></span><br><span class="line"><span class="comment"># CORS_ORIGIN_WHITELIST = (&#x27;www.abc.com&#x27;, &#x27;www.baidu.com&#x27;)</span></span><br><span class="line"><span class="comment"># CORS_ORIGIN_REGEX_WHITELIST = (&#x27;...&#x27;, )</span></span><br><span class="line"><span class="comment"># CORS_ALLOW_CREDENTIALS = True</span></span><br><span class="line"><span class="comment"># CORS_ALLOW_METHODS = (&#x27;GET&#x27;, &#x27;POST&#x27;, &#x27;PUT&#x27;, &#x27;DELETE&#x27;)</span></span><br></pre></td></tr></table></figure>
<p>问题2：网站图片（水印、剪裁）和视频（截图、水印、转码）是如何处理的？（云存储、FFmpeg）</p>
<p>问题3：网站如何架设（静态资源）文件系统？（FastDFS、云存储、CDN）</p>
<h3 id="安全保护">安全保护</h3>
<p>问题1：什么是跨站脚本攻击（XSS)，如何防范？（对提交的内容进行消毒）</p>
<p>问题2：什么是跨站身份伪造（CSRF），如何防范？（使用随机令牌）</p>
<p>问题3：什么是SQL注射攻击（SQL Injection），如何防范？（不拼接SQL语句，避免使用单引号）</p>
<p>问题4：什么是点击劫持攻击（Click-hacking），如何防范？（不允许<code>&lt;iframe&gt;</code>加载非同源站点内容）</p>
<h4 id="Django提供的安全措施">Django提供的安全措施</h4>
<p>签名数据的API</p>
   <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.core.signing <span class="keyword">import</span> Signer</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>signer = Signer()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>value = signer.sign(<span class="string">&#x27;hello, world!&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>value</span><br><span class="line"><span class="string">&#x27;hello, world!:BYMlgvWMTSPLxC-DqxByleiMVXU&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>signer.unsign(value)</span><br><span class="line"><span class="string">&#x27;hello, world!&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>signer = Signer(salt=<span class="string">&#x27;yoursalt&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>signer.sign(<span class="string">&#x27;hello, world!&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;hello, world!:9vEvG6EA05hjMDB5MtUr33nRA_M&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.core.signing <span class="keyword">import</span> TimestampSigner</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>signer = TimestampSigner()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>value = signer.sign(<span class="string">&#x27;hello, world!&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>value</span><br><span class="line"><span class="string">&#x27;hello, world!:1fpmcQ:STwj464IFE6eUB-_-hyUVF3d2So&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>signer.unsign(value, max_age=<span class="number">5</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">&quot;&lt;console&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    File <span class="string">&quot;/Users/Hao/Desktop/fang.com/venv/lib/python3.6/site-packages/django/core/signing.py&quot;</span>, line <span class="number">198</span>, <span class="keyword">in</span> unsign</span><br><span class="line">    <span class="string">&#x27;Signature age %s &gt; %s seconds&#x27;</span> % (age, max_age))</span><br><span class="line">    django.core.signing.SignatureExpired: Signature age <span class="number">21.020604848861694</span> &gt; <span class="number">5</span> seconds</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>signer.unsign(value, max_age=<span class="number">120</span>)</span><br><span class="line"><span class="string">&#x27;hello, world!&#x27;</span></span><br></pre></td></tr></table></figure>
<p>CSRF令牌和小工具</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;% csrf_token %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>@csrf_exempt：免除令牌</li>
<li>@csrf_protect：提供令牌保护</li>
<li>@require_csrf_token：提供令牌保护</li>
<li>@ensure_csrf_cookie：强制视图发送带令牌的cookie</li>
</ul>
<blockquote>
<p>说明：可以在Chrome浏览器中安装EditThisCookie插件来方便的查看Cookie。</p>
</blockquote>
<h4 id="用户敏感信息的保护">用户敏感信息的保护</h4>
<ol>
<li>
<p>哈希摘要（签名）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>md5_hasher = hashlib.md5()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>md5_hasher.update(<span class="string">&#x27;hello, world!&#x27;</span>.encode())</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>md5_hasher.hexdigest()</span><br><span class="line"><span class="string">&#x27;3adbbad1791fbae3ec908894c4963870&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sha1_hasher = hashlib.sha1()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sha1_hasher.update(<span class="string">&#x27;hello, world!&#x27;</span>.encode())</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sha1_hasher.update(<span class="string">&#x27;goodbye, world!&#x27;</span>.encode())</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sha1_hasher.hexdigest()</span><br><span class="line"><span class="string">&#x27;1f09d30c707d53f3d16c530dd73d70a6ce7596a9&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>加密和解密（对称加密和非对称加密）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install pycrypto</span><br></pre></td></tr></table></figure>
<p>AES对称加密：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> Crypto <span class="keyword">import</span> Random</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>key = md5(<span class="string">b&#x27;mysecret&#x27;</span>).hexdigest()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>iv = Random.new().read(AES.block_size)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>str1 = <span class="string">&#x27;我爱你们！&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>str2 = AES.new(key, AES.MODE_CFB, iv).encrypt(str1)</span><br><span class="line"><span class="string">b&#x27;p\x96o\x85\x0bq\xc4-Y\xc4\xbcp\n)&amp;&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>str3 = AES.new(key, AES.MODE_CFB, iv).decrypt(str2).decode()</span><br><span class="line"><span class="string">&#x27;我爱你们！&#x27;</span></span><br></pre></td></tr></table></figure>
<p>RSA非对称加密：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 生成密钥对</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>key_pair = RSA.generate(<span class="number">2048</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 导入公钥</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pub_key = RSA.importKey(key_pair.publickey().exportKey())</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 导入私钥</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pri_key = RSA.importKey(key_pair.exportKey())</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 明文</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>message1 = <span class="string">&#x27;hello, world!&#x27;</span>.encode()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 加密数据</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>message2 = pub_key.encrypt(message1, <span class="literal">None</span>)</span><br><span class="line">(<span class="string">b&#x27;\x03\x86t\xa0\x00\xc4\xea\xd2\x80\xed\xa7YN7\x07\xff\x88\xaa\x1eW\x0cmH0\x06\xa7\&#x27;\xbc&lt;w@q\x8b\xaf\xf7:g\x92&#123;=\xe2E\xa5@\x1as2\xdd\xcb\x8e[\x98\x85\xdf,X\xecj.U\xd6\xa7W&amp;u\&#x27;Uz&quot;\x0f\x0e\\&lt;\xa4\xfavC\x93\xa7\xbcO&quot;\xb9a\x06]&lt;.\xc1\r1&#125;*\xdf\xccdqXML\x93\x1b\xe9\xda\xdf\xab|\xf8\x18\xe4\x99\xbb\x7f\x18&#125;\xd9\x9a\x1e*J\\\xca\x1a\xd1\x85\xf7t\x81\xd95&#123;\x19\xc9\x81\xb6^&#125;\x9c5\xca\xfe\xcf\xc8\xd8M\x9a\x8c-\xf1t\xee\xf9\x12\x90\x01\xca\x92~\x00c5qg5g\x95&amp;\x10\xb1\x0b\x1fo\x95\xf2\xbc\x8d\xf3f&quot;@\xc5\x188\x0bX\x9cfo\xea\x97\x05@\xe5\xb2\xda\xb8\x97a\xa5w\xa8\x01\x9a\xa5N\xc4\x81\x8d\x0f&lt;\x96iU\xd3\x95\xacJZs\xab_ #\xee\xf9\x0f\xf2\x12\xdb\xfc\xf8g\x18v\x02k+\xda\x16Si\xbf\xbb\xec\xf7w\x90\xde\xae\x97\t\xed&#123;&#125;5\xd0&#x27;</span>,)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 解密数据</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>message3 = pri_key.decrypt(message2)</span><br><span class="line"><span class="string">&#x27;hello, world!&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="安全相关建议">安全相关建议</h4>
<ol>
<li>虽然 Django 自带了稳固的安全保护措施，但是依然要采用正确的方式部署应用程序，利用 Web 服务器、操作系统和其他组件提供的安全保护措施。</li>
<li>记得把 Python 代码放在 Web 服务器的文档根目录之外，避免代码意外泄露。</li>
<li>谨慎处理用户上传的文件。</li>
<li>Django本身没有对请求次数加以限制（包括验证用户身份的请求），为了防止暴力攻击和破解，可以考虑使用具有一次消费性的验证码或对这类请求的次数进行限制。</li>
<li>将缓存系统、数据库服务器以及重要的资源服务器都放在第二级防火墙之后（不要放在DMZ）。</li>
</ol>
<h3 id="测试相关-2">测试相关</h3>
<p>测试是发现和标记缺陷的过程。所谓的缺陷是指实际结果和期望结果之间的任何差别。有的地方，测试也被认为是执行以找出错误为目的的程序的过程。 测试是为了让产品达到以下目标：</p>
<ol>
<li>满足需求用户满意</li>
<li>改善产品的市场占有率</li>
<li>树立对产品的信任</li>
<li>减少开发和维护的成本</li>
</ol>
<h4 id="功能测试">功能测试</h4>
<p>如果一个软件单元的行为方式与它的开发规范完全一样，那么该软件单元就通过了它的功能测试。</p>
<ul>
<li>白盒测试：开发人员自己实现，最基本的形式是单元测试，还有集成测试和系统测试。</li>
<li>黑盒测试：由开发团队之外的人执行，对测试代码没有可见性，将被测系统视为黑盒子。通常由测试人员或QA工程师来执行，Web应用可以通过Selenium这样的测试框架自动化实施。</li>
</ul>
<h4 id="性能测试">性能测试</h4>
<p>软件在高工作负载下对其响应性和健壮性展开的测试。</p>
<ul>
<li>
<p>负载测试：在特定负载下执行的测试。</p>
</li>
<li>
<p>压力测试：突发条件或极限条件下的性能测试。</p>
</li>
</ul>
<h4 id="安全性测试">安全性测试</h4>
<p>系统的敏感数据都是经过认证和授权之后才能访问。</p>
<h4 id="其他测试">其他测试</h4>
<p>易用性测试 / 安装测试 / 可访问性测试</p>
<h4 id="单元测试-2">单元测试</h4>
<p>测试函数和对象的方法（程序中最小最基本的单元）。通过对实际输出和预期输出的比对以及各种的断言条件来判定被测单元是否满足设计需求。</p>
<ul>
<li>测试用例</li>
<li>测试固件 - 每次测试时都要使用的东西。</li>
<li>测试套件（测试集）- 组合了多个测试用例而构成的集合。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UtilTest</span>(unittest.TestCase):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\d&#123;6&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_gen_mobile_code</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">            self.assertIsNotNone(self.pattern.<span class="keyword">match</span>(gen_mobile_code()))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_to_md5_hex</span>(<span class="params">self</span>):</span><br><span class="line">        md5_dict = &#123;</span><br><span class="line">            <span class="string">&#x27;123456&#x27;</span>: <span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;123123123&#x27;</span>: <span class="string">&#x27;f5bb0c8de146c67b44babbf4e6584cc0&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;1qaz2wsx&#x27;</span>: <span class="string">&#x27;1c63129ae9db9c60c3e8aa94d3e00495&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> md5_dict.items():</span><br><span class="line">            self.assertEqual(value, to_md5_hex(key))</span><br></pre></td></tr></table></figure>
<p><code>TestCase</code>的断言方法：</p>
<ul>
<li>assertEqual / assertNotEqual</li>
<li>assertTrue / assertFalse / assertIsNot</li>
<li>assertRaise / assertRaiseRegexp</li>
<li>assertAlmostEqual / assertNotAlmostEqual</li>
<li>assertGreater / assertGreaterEqual / assertLess / assertLessEqual</li>
<li>assertRegexpMatches / assertNotRegexpMatches</li>
<li>assertListEqual / assertSetEqual / assertTupleEqual / assertDictEqual</li>
</ul>
<p>可以使用nose2或pytest来辅助执行单元测试，同时通过cov-core或pytest-cov可以对测试覆度进行评估。覆盖率由百分比表示。比如测试代码执行过了程序的每一行，那么覆盖率就是100%。这种时候，几乎不会出现新程序上线后突然无法运行的尴尬情况。覆盖率不关心代码内容究竟是什么，覆盖率是用来检查“测试代码不足、测试存在疏漏”的一个指标，“测试内容是否妥当”并不归它管。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install nose2 pytest cov-core pytest-cov</span><br></pre></td></tr></table></figure>
<p>可以使用Selenium来实现Web应用的自动化测试，它还可以用于屏幕抓取与浏览器行为模拟，通过爬虫抓取页面上的动态数据也可以使用它。Selenium其实包括三个部分：</p>
<ul>
<li>
<p>Selenium IDE：嵌入到浏览器的插件，可以录制和回放脚本。</p>
<p><img src="./res/selenium_ide.png" alt=""></p>
</li>
<li>
<p>Selenium WebDriver：支持多种语言可以操控浏览器的API。</p>
</li>
<li>
<p>Selenium Standalone Server：Selenium Grid、远程控制、分布式部署。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install selenium</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.fixture(<span class="params">scope=<span class="string">&#x27;session&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chrome</span>():</span><br><span class="line">    <span class="comment"># 设置使用无头浏览器(不会打开浏览器窗口)</span></span><br><span class="line">    options = webdriver.ChromeOptions()</span><br><span class="line">    options.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">    driver = webdriver.Chrome(options=options)</span><br><span class="line">    <span class="keyword">yield</span> driver</span><br><span class="line">    driver.quit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_baidu_index</span>(<span class="params">chrome</span>):</span><br><span class="line">    chrome.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> chrome.title == <span class="string">&#x27;百度一下，你就知道&#x27;</span></span><br></pre></td></tr></table></figure>
<p>除了Selenium之外，还有一个Web自动化测试工具名叫Robot Framework。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nose2 -v -C</span><br><span class="line">pytest --cov</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Ran 7 tests in 0.002s</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line">Name                       Stmts   Miss  Cover</span><br><span class="line">----------------------------------------------</span><br><span class="line">example01.py                  15      0   100%</span><br><span class="line">example02.py                  49     49     0%</span><br><span class="line">example03.py                  22     22     0%</span><br><span class="line">example04.py                  61     61     0%</span><br><span class="line">example05.py                  29     29     0%</span><br><span class="line">example06.py                  39     39     0%</span><br><span class="line">example07.py                  19     19     0%</span><br><span class="line">example08.py                  27     27     0%</span><br><span class="line">example09.py                  18     18     0%</span><br><span class="line">example10.py                  19     19     0%</span><br><span class="line">example11.py                  22     22     0%</span><br><span class="line">example12.py                  28     28     0%</span><br><span class="line">example13.py                  28     28     0%</span><br><span class="line">test_ddt_example.py           18      0   100%</span><br><span class="line">test_pytest_example.py        11      6    45%</span><br><span class="line">test_unittest_example.py      22      0   100%</span><br><span class="line">----------------------------------------------</span><br><span class="line">TOTAL                        427    367    14%</span><br></pre></td></tr></table></figure>
<p>在测试过程中需要孤立各种外部依赖（数据库、外部接口调用、时间依赖），具体又包括两个方面：</p>
<ol>
<li>
<p>数据源：数据本地化 / 置于内存中 / 测试之后回滚</p>
</li>
<li>
<p>资源虚拟化：存根/桩（stub）、仿制/模拟（mock）、伪造（fake）</p>
<ul>
<li>stub：测试期间为提供响应的函数生成的替代品</li>
<li>mock：代替实际对象（以及该对象的API）的对象</li>
<li>fake：没有达到生产级别的轻量级对象</li>
</ul>
</li>
</ol>
<h4 id="集成测试">集成测试</h4>
<p>集成多个函数或方法的输入输出的测试，测试时需要将多个测试对象组合在一起。</p>
<ul>
<li>测试组件互操作性 / 需求变更测试 / 外部依赖和API / 调试硬件问题 / 在代码路径中发现异常</li>
</ul>
<h4 id="系统测试">系统测试</h4>
<p>对需求的测试，测试成品是否最终满足了所有需求，在客户验收项目时进行。</p>
<h4 id="数据驱动测试">数据驱动测试</h4>
<p>使用外部数据源实现对输入值与期望值的参数化，避免在测试中使用硬编码的数据。</p>
<p>被测函数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>
<p>data.csv文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3,1,2</span><br><span class="line">0,1,-1</span><br><span class="line">100,50,50</span><br><span class="line">100,1,99</span><br><span class="line">15,7,8</span><br></pre></td></tr></table></figure>
<p>测试代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> TestCase</span><br><span class="line"><span class="keyword">from</span> ddt <span class="keyword">import</span> ddt, data, unpack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ddt</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestAdd</span>(<span class="title class_ inherited__">TestCase</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_data_from_csv</span>(<span class="params">filename</span>):</span><br><span class="line">        data_items = []</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;r&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> fs:</span><br><span class="line">            reader = csv.reader(fs)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">                data_items.append(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, row)))</span><br><span class="line">        <span class="keyword">return</span> data_items</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @data(<span class="params">*load_data_from_csv(<span class="params"><span class="string">&#x27;data.csv&#x27;</span></span>)</span>)</span></span><br><span class="line"><span class="meta">    @unpack</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add</span>(<span class="params">self, result, param1, param2</span>):</span><br><span class="line">        self.assertEqual(result, add(param1, param2))</span><br></pre></td></tr></table></figure>
<h4 id="Django中的测试">Django中的测试</h4>
<ol>
<li>测试Django视图 - Django中提供的<code>TestCase</code>扩展了<code>unittest</code>中的<code>TestCase</code>，绑定了一个名为<code>client</code>的属性，可以用来模拟浏览器发出的GET、POST、DELETE、PUT等请求。</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SomeViewTest</span>(<span class="title class_ inherited__">TestCase</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_example_view</span>(<span class="params">self</span>):</span><br><span class="line">        resp = self.client.get(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        self.assertEqual(<span class="number">200</span>, resp.status_code)</span><br><span class="line">        self.assertEqual(<span class="number">5</span>, resp.context[<span class="string">&#x27;num&#x27;</span>])</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>运行测试 - 配置测试数据库。</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>: <span class="number">3306</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;DbName&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>: os.environ[<span class="string">&#x27;DB_USER&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>: os.environ[<span class="string">&#x27;DB_PASS&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;TEST&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;DbName_for_testing&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;CHARSET&#x27;</span>: <span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python manage.py test</span><br><span class="line">python manage.py test common</span><br><span class="line">python manage.py test common.tests.UtilsTest</span><br><span class="line">python manage.py test common.tests.UtilsTest.test_to_md5_hex</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>评估测试覆盖度</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install coverage</span><br><span class="line">coverage run --source=&lt;path1&gt; --omit=&lt;path2&gt; manage.py test common</span><br><span class="line">coverage report</span><br><span class="line"></span><br><span class="line">Name                            Stmts   Miss  Cover</span><br><span class="line">---------------------------------------------------</span><br><span class="line">common/__init__.py                  0      0   100%</span><br><span class="line">common/admin.py                     1      0   100%</span><br><span class="line">common/apps.py                      3      3     0%</span><br><span class="line">common/forms.py                    16     16     0%</span><br><span class="line">common/helper.py                   32     32     0%</span><br><span class="line">common/middlewares.py              19     19     0%</span><br><span class="line">common/migrations/__init__.py       0      0   100%</span><br><span class="line">common/models.py                   71      2    97%</span><br><span class="line">common/serializers.py              14     14     0%</span><br><span class="line">common/tests.py                    14      8    43%</span><br><span class="line">common/urls_api.py                  3      3     0%</span><br><span class="line">common/urls_user.py                 3      3     0%</span><br><span class="line">common/utils.py                    22      7    68%</span><br><span class="line">common/views.py                    69     69     0%</span><br><span class="line">---------------------------------------------------</span><br><span class="line">TOTAL                             267    176    34%</span><br></pre></td></tr></table></figure>
<h4 id="性能测试-2">性能测试</h4>
<p>问题1：性能测试的指标有哪些？</p>
<ol>
<li>
<p>ab（ Apache Benchmark） / webbench / httpperf</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line">ab -c 10 -n 1000 http://www.baidu.com/</span><br><span class="line">...</span><br><span class="line">Benchmarking www.baidu.com (be patient).....done</span><br><span class="line">Server Software:        BWS/1.1</span><br><span class="line">Server Hostname:        www.baidu.com</span><br><span class="line">Server Port:            80</span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        118005 bytes</span><br><span class="line">Concurrency Level:      10</span><br><span class="line">Time taken for tests:   0.397 seconds</span><br><span class="line">Complete requests:      100</span><br><span class="line">Failed requests:        98</span><br><span class="line">   (Connect: 0, Receive: 0, Length: 98, Exceptions: 0)</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      11918306 bytes</span><br><span class="line">HTML transferred:       11823480 bytes</span><br><span class="line">Requests per second:    252.05 [#/sec] (mean)</span><br><span class="line">Time per request:       39.675 [ms] (mean)</span><br><span class="line">Time per request:       3.967 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          29335.93 [Kbytes/sec] received</span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        6    7   0.6      7       9</span><br><span class="line">Processing:    20   27  22.7     24     250</span><br><span class="line">Waiting:        8   11  21.7      9     226</span><br><span class="line">Total:         26   34  22.8     32     258</span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">    32</span></span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">    34</span></span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">    34</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">    34</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">    36</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">    39</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">    51</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">   258</span></span><br><span class="line"><span class="meta prompt_"> 100% </span><span class="language-bash">   258 (longest request)</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>mysqlslap</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mysqlslap -a -c 100 -h 1.2.3.4 -u root -p</span><br><span class="line">mysqlslap -a -c 100 --number-of-queries=1000 --auto-generate-sql-load-type=read -h &lt;负载均衡服务器IP地址&gt; -u root -p</span><br><span class="line">mysqlslap -a --concurrency=50,100 --number-of-queries=1000 --debug-info --auto-generate-sql-load-type=mixed -h 1.2.3.4 -u root -p</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>sysbench</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysbench --test=threads --num-threads=64 --thread-yields=100 --thread-locks=2 run</span><br><span class="line">sysbench --test=memory --num-threads=512 --memory-block-size=256M --memory-total-size=32G run</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>JMeter</p>
<p>请查看<a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/l-jmeter/index.html">《使用JMeter进行性能测试》</a>。</p>
</li>
<li>
<p>LoadRunner / QTP</p>
</li>
</ol>
<h3 id="项目调试">项目调试</h3>
<p>可以使用django-debug-toolbar来辅助项目调试。</p>
<ol>
<li>
<p>安装</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install django-debug-toolbar</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置 - <a target="_blank" rel="noopener" href="http://xn--settings-0n3mm27o.py">修改settings.py</a>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;debug_toolbar&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;debug_toolbar.middleware.DebugToolbarMiddleware&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">DEBUG_TOOLBAR_CONFIG = &#123;</span><br><span class="line">    <span class="comment"># 引入jQuery库</span></span><br><span class="line">    <span class="string">&#x27;JQUERY_URL&#x27;</span>: <span class="string">&#x27;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&#x27;</span>,</span><br><span class="line">    <span class="comment"># 工具栏是否折叠</span></span><br><span class="line">    <span class="string">&#x27;SHOW_COLLAPSED&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="comment"># 是否显示工具栏</span></span><br><span class="line">    <span class="string">&#x27;SHOW_TOOLBAR_CALLBACK&#x27;</span>: <span class="keyword">lambda</span> x: <span class="literal">True</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置 - <a target="_blank" rel="noopener" href="http://xn--urls-486fx14i.py">修改urls.py</a>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> settings.DEBUG:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> debug_toolbar</span><br><span class="line"></span><br><span class="line">    urlpatterns.insert(<span class="number">0</span>, path(<span class="string">&#x27;__debug__/&#x27;</span>, include(debug_toolbar.urls)))</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用 - 在页面右侧可以看到一个调试工具栏，上面包括了执行时间、项目设置、请求头、SQL、静态资源、模板、缓存、信号等调试信息，查看起来非常的方便。</p>
</li>
<li>
<p>项目上线之前，请记住<strong>去掉django-debug-toolbar相关的所有配置</strong>。</p>
</li>
</ol>
<h3 id="部署相关">部署相关</h3>
<p>请参考<a href="98.%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%8A%E7%BA%BF%E5%92%8C%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98.md">《项目部署上线和性能调优》</a>。</p>
<h3 id="性能相关">性能相关</h3>
<h4 id="网站优化两大定律：">网站优化两大定律：</h4>
<ol>
<li>
<p>尽可能的使用缓存 - 牺牲空间换取时间（普适策略）。</p>
</li>
<li>
<p>能推迟的都推迟 - 使用消息队列将并行任务串行来缓解服务器压力。</p>
<ul>
<li>服务器CPU利用率出现瞬时峰值 - 削峰（CPU利用率平缓的增长）</li>
<li>上下游节点解耦合（下订单和受理订单的系统通常是分离的）</li>
</ul>
</li>
</ol>
<h4 id="Django框架">Django框架</h4>
<ol>
<li>
<p>配置缓存来缓解数据库的压力，并有合理的机制应对<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangweizhong/p/6258797.html">缓存穿透和缓存雪崩</a>。</p>
</li>
<li>
<p>开启<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/2.0/ref/templates/api/#django.template.loaders.cached.Loader">模板缓存</a>来加速模板的渲染。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR, <span class="string">&#x27;templates&#x27;</span>), ],</span><br><span class="line">        <span class="comment"># &#x27;APP_DIRS&#x27;: True,</span></span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&#x27;loaders&#x27;</span>: [(</span><br><span class="line">                <span class="string">&#x27;django.template.loaders.cached.Loader&#x27;</span>, [</span><br><span class="line">                    <span class="string">&#x27;django.template.loaders.filesystem.Loader&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;django.template.loaders.app_directories.Loader&#x27;</span>,</span><br><span class="line">                ], ),</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>用惰性求值、迭代器、<code>defer()</code>、<code>only()</code>等缓解内存压力。</p>
</li>
<li>
<p>用<code>select_related()</code>和<code>prefetch_related()</code>执行预加载避免“1+N查询问题”。</p>
</li>
</ol>
<h4 id="数据库-3">数据库</h4>
<ol>
<li>
<p>用ID生成器代替自增主键（性能更好、适用于分布式环境）。</p>
<ul>
<li>
<p>自定义ID生成器 - snowflake</p>
</li>
<li>
<p>UUID</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>my_uuid = uuid.uuid1()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>my_uuid</span><br><span class="line">UUID(<span class="string">&#x27;63f859d0-a03a-11e8-b0ad-60f81da8d840&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>my_uuid.<span class="built_in">hex</span></span><br><span class="line"><span class="string">&#x27;63f859d0a03a11e8b0ad60f81da8d840&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>避免不必要的外键列上的约束（除非必须保证参照完整性），更不要使用触发器之类的机制。</p>
</li>
<li>
<p>使用索引来优化查询性能（索引放在要用于查询的字段上）。InnoDB用的是BTREE索引，使用&gt;、&lt;、&gt;=、&lt;=、BETWEEN或者LIKE ‘pattern’（pattern不以通配符开头）时都可以用到索引。因为建立索引需要额外的磁盘空间，而主键上是有默认的索引，所以主键要尽可能选择较短的数据类型来减少磁盘占用，提高索引的缓存效果。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_goods_name <span class="keyword">on</span> tb_goods (gname(<span class="number">10</span>));</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 无法使用索引</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_goods <span class="keyword">where</span> gname <span class="keyword">like</span> <span class="string">&#x27;%iPhone%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 可以使用索引</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_goods <span class="keyword">where</span> gname <span class="keyword">like</span> <span class="string">&#x27;iPhone%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 无法使用索引</span></span><br><span class="line">Goods.objects.<span class="built_in">filter</span>(name_icontains=<span class="string">&#x27;iPhone&#x27;</span>)</span><br><span class="line"><span class="comment"># 可以使用索引</span></span><br><span class="line">Goods.objects.<span class="built_in">filter</span>(name__istartswith=<span class="string">&#x27;iPhone&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用存储过程（存储在服务器端编译过的一组SQL语句）。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> if <span class="keyword">exists</span> sp_avg_sal_by_dept;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> sp_avg_sal_by_dept(deptno <span class="type">integer</span>, <span class="keyword">out</span> avg_sal <span class="type">float</span>)</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">avg</span>(sal) <span class="keyword">into</span> avg_sal <span class="keyword">from</span> TbEmp <span class="keyword">where</span> dno<span class="operator">=</span>deptno;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> sp_avg_sal_by_dept(<span class="number">10</span>, <span class="variable">@a</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="variable">@a</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.db <span class="keyword">import</span> connection</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor = connection.cursor()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor.callproc(<span class="string">&#x27;sp_avg_sal_by_dept&#x27;</span>, (<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor.execute(<span class="string">&#x27;select @_sp_avg_sal_by_dept_1&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cursor.fetchone()</span><br><span class="line">(<span class="number">2675.0</span>,)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用数据分区。通过分区可以存储更多的数据、优化查询更大的吞吐量、可以快速删除过期的数据。关于这个知识点可以看看MySQL的<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/partitioning-overview.html">官方文档</a>。</p>
<ul>
<li>RANGE分区：基于连续区间范围，把数据分配到不同的分区。</li>
<li>LIST分区：基于枚举值的范围，把数据分配到不同的分区。</li>
<li>HASH分区 / KEY分区：基于分区个数，把数据分配到不同的分区。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_emp (</span><br><span class="line">    eno <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    ename <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    job <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    hiredate <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    dno <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> HASH(dno)</span><br><span class="line">PARTITIONS <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_emp (</span><br><span class="line">    eno <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    ename <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    job <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    hiredate <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    dno <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>( <span class="keyword">YEAR</span>(hiredate) ) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p0 <span class="keyword">VALUES</span> LESS THAN (<span class="number">1960</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p1 <span class="keyword">VALUES</span> LESS THAN (<span class="number">1970</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2 <span class="keyword">VALUES</span> LESS THAN (<span class="number">1980</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p3 <span class="keyword">VALUES</span> LESS THAN (<span class="number">1990</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p4 <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用<code>explain</code>来分析查询性能 - 执行计划。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> ...;</span><br></pre></td></tr></table></figure>
<p><code>explain</code>结果解析：</p>
<ul>
<li>select_type：表示select操作的类型，常见的值有SIMPLE（简单查询，没有使用子查询或者表连接查询）、PRIMARY（主查询，外层的查询）、UNION（并集操作中的第二个或者后面的查询）、SUBQUERY（子查询中的第一个SELECT）等。</li>
<li>table：输出结果的表。</li>
<li>type：MySQL在表中找到所需行的方式，也称为访问类型，常见的值有：
<ul>
<li>ALL：全表扫描（遍历全表找到匹配的行）</li>
<li>index：索引全扫描（遍历整个索引）</li>
<li>range：索引范围扫描</li>
<li>ref：非唯一索引扫描或唯一索引的前缀扫描</li>
<li>eq_ref：唯一索引扫描</li>
<li>const / system：表中最多有一行匹配</li>
<li>NULL：不用访问表或者索引</li>
</ul>
</li>
<li>possible_keys：查询时可能用到的索引。</li>
<li>key：实际使用的索引。</li>
<li>key_len：使用到索引字段的长度。</li>
<li>rows：扫描行的数量。</li>
<li>Extra：额外的信息（执行情况的说明或描述）。</li>
</ul>
<blockquote>
<p>说明：关于MySQL更多的知识尤其是性能调优和运维方面的内容，推荐大家阅读网易出品的《深入浅出MySQL（第2版）》，网易出品必属精品。</p>
</blockquote>
</li>
<li>
<p>使用慢查询日志来发现性能低下的查询。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;slow_query%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name             <span class="operator">|</span> <span class="keyword">Value</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> slow_query_log            <span class="operator">|</span> OFF                              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slow_query_log_file       <span class="operator">|</span> <span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>localhost<span class="operator">-</span>slow.log   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+----------------------------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;long_query_time&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">10.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> slow_query_log<span class="operator">=</span><span class="string">&#x27;ON&#x27;</span>; </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> long_query_time<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">slow_query_log</span>=<span class="literal">ON</span></span><br><span class="line"><span class="attr">slow_query_log_file</span>=/usr/local/mysql/data/slow.log</span><br><span class="line"><span class="attr">long_query_time</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://yuanweize.github.io">GreenSeaa</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yuanweize.github.io/2022/08/09/Python-100-Days/Day91-100/95.%E4%BD%BF%E7%94%A8Django%E5%BC%80%E5%8F%91%E5%95%86%E4%B8%9A%E9%A1%B9%E7%9B%AE/">https://yuanweize.github.io/2022/08/09/Python-100-Days/Day91-100/95.使用Django开发商业项目/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yuanweize.github.io" target="_blank">HExLL</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/Day91-100/">Day91-100</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/09/Python-100-Days/Day91-100/97.%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E6%8A%80%E6%9C%AF%E8%A6%81%E7%82%B9%E5%89%96%E6%9E%90/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">97.电商网站技术要点剖析</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/09/Python-100-Days/Day91-100/96.%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">96.软件测试和自动化测试</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/08/09/Python-100-Days/Day91-100/100.Python%E9%9D%A2%E8%AF%95%E9%A2%98%E5%AE%9E%E5%BD%95/" title="100.Python面试题实录"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 09-08-2022</div><div class="title">100.Python面试题实录</div></div></a></div><div><a href="/2022/08/09/Python-100-Days/Day91-100/91.%E5%9B%A2%E9%98%9F%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="91.团队项目开发的问题和解决方案"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 09-08-2022</div><div class="title">91.团队项目开发的问题和解决方案</div></div></a></div><div><a href="/2022/08/09/Python-100-Days/Day91-100/92.Docker%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3/" title="92.Docker容器技术详解"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 09-08-2022</div><div class="title">92.Docker容器技术详解</div></div></a></div><div><a href="/2022/08/09/Python-100-Days/Day91-100/93.MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" title="93.MySQL性能优化"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 09-08-2022</div><div class="title">93.MySQL性能优化</div></div></a></div><div><a href="/2022/08/09/Python-100-Days/Day91-100/94.%E7%BD%91%E7%BB%9CAPI%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1/" title="94.网络API接口设计"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 09-08-2022</div><div class="title">94.网络API接口设计</div></div></a></div><div><a href="/2022/08/09/Python-100-Days/Day91-100/97.%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99%E6%8A%80%E6%9C%AF%E8%A6%81%E7%82%B9%E5%89%96%E6%9E%90/" title="97.电商网站技术要点剖析"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 09-08-2022</div><div class="title">97.电商网站技术要点剖析</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s.gravatar.com/avatar/50de7ee8a1fc96ada7495a641400642d?s=512" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">GreenSeaa</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">801</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">70</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">69</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yuanweize"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/yuanweize" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:info@hktse.cz" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://t.me/greenseaa" target="_blank" title=""><i class="fab fa-telegram"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Here is HExLL</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Django%E5%BC%80%E5%8F%91%E5%95%86%E4%B8%9A%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">使用Django开发商业项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Web%E5%BA%94%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">Web应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MVC%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">MVC架构模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94"><span class="toc-number">1.3.</span> <span class="toc-text">HTTP请求和响应</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP%E8%AF%B7%E6%B1%82-%E8%AF%B7%E6%B1%82%E8%A1%8C-%E8%AF%B7%E6%B1%82%E5%A4%B4-%E7%A9%BA%E8%A1%8C-%E6%B6%88%E6%81%AF%E4%BD%93"><span class="toc-number">1.3.1.</span> <span class="toc-text">HTTP请求 &#x3D; 请求行+请求头+空行+[消息体]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP%E5%93%8D%E5%BA%94-%E5%93%8D%E5%BA%94%E8%A1%8C-%E5%93%8D%E5%BA%94%E5%A4%B4-%E7%A9%BA%E8%A1%8C-%E6%B6%88%E6%81%AF%E4%BD%93"><span class="toc-number">1.3.2.</span> <span class="toc-text">HTTP响应 &#x3D; 响应行+响应头+空行+消息体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B-Model"><span class="toc-number">1.4.</span> <span class="toc-text">数据模型(Model)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0-Controller"><span class="toc-number">1.5.</span> <span class="toc-text">视图函数(Controller)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.1.</span> <span class="toc-text">如何设计视图函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URL%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text">URL配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF-View"><span class="toc-number">1.6.</span> <span class="toc-text">模板(View)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E6%B8%B2%E6%9F%93"><span class="toc-number">1.6.1.</span> <span class="toc-text">后端渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E6%B8%B2%E6%9F%93"><span class="toc-number">1.6.2.</span> <span class="toc-text">前端渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%A7%86%E5%9B%BE"><span class="toc-number">1.6.3.</span> <span class="toc-text">其他视图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6-2"><span class="toc-number">1.7.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BF%80%E6%B4%BB%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.7.1.</span> <span class="toc-text">激活中间件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6-2"><span class="toc-number">1.7.2.</span> <span class="toc-text">自定义中间件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.7.3.</span> <span class="toc-text">内置中间件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95"><span class="toc-number">1.8.</span> <span class="toc-text">表单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie%E5%92%8CSession-2"><span class="toc-number">1.9.</span> <span class="toc-text">Cookie和Session</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Session%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">1.9.1.</span> <span class="toc-text">Session的配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">1.10.</span> <span class="toc-text">缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98"><span class="toc-number">1.10.1.</span> <span class="toc-text">配置缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E7%AB%99%E7%BC%93%E5%AD%98"><span class="toc-number">1.10.2.</span> <span class="toc-text">全站缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E5%B1%82%E7%BC%93%E5%AD%98"><span class="toc-number">1.10.3.</span> <span class="toc-text">视图层缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%86%85%E5%AE%B9-4"><span class="toc-number">1.10.4.</span> <span class="toc-text">其他内容</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">1.11.</span> <span class="toc-text">日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-number">1.11.1.</span> <span class="toc-text">日志级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="toc-number">1.11.2.</span> <span class="toc-text">日志配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">1.11.3.</span> <span class="toc-text">日志分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RESTful"><span class="toc-number">1.12.</span> <span class="toc-text">RESTful</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8djangorestframework"><span class="toc-number">1.12.1.</span> <span class="toc-text">使用djangorestframework</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8-2"><span class="toc-number">1.12.2.</span> <span class="toc-text">编写序列化器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%951%EF%BC%9A%E4%BD%BF%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">1.12.3.</span> <span class="toc-text">方法1：使用装饰器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%952%EF%BC%9A%E4%BD%BF%E7%94%A8APIView%E5%8F%8A%E5%85%B6%E5%AD%90%E7%B1%BB"><span class="toc-number">1.12.4.</span> <span class="toc-text">方法2：使用APIView及其子类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%953%EF%BC%9A%E4%BD%BF%E7%94%A8ViewSet%E5%8F%8A%E5%85%B6%E5%AD%90%E7%B1%BB"><span class="toc-number">1.12.5.</span> <span class="toc-text">方法3：使用ViewSet及其子类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E-512"><span class="toc-number">1.12.6.</span> <span class="toc-text">补充说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%95%B0%E6%8D%AE"><span class="toc-number">1.12.7.</span> <span class="toc-text">过滤数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">1.12.8.</span> <span class="toc-text">身份认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E4%BA%88%E6%9D%83%E9%99%90"><span class="toc-number">1.12.9.</span> <span class="toc-text">授予权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E9%99%90%E6%B5%81"><span class="toc-number">1.12.10.</span> <span class="toc-text">访问限流</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.13.</span> <span class="toc-text">异步任务和计划任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Celery%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.13.1.</span> <span class="toc-text">Celery的应用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98-2"><span class="toc-number">1.14.</span> <span class="toc-text">其他问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.15.</span> <span class="toc-text">安全保护</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Django%E6%8F%90%E4%BE%9B%E7%9A%84%E5%AE%89%E5%85%A8%E6%8E%AA%E6%96%BD"><span class="toc-number">1.15.1.</span> <span class="toc-text">Django提供的安全措施</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E7%9A%84%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.15.2.</span> <span class="toc-text">用户敏感信息的保护</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.15.3.</span> <span class="toc-text">安全相关建议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3-2"><span class="toc-number">1.16.</span> <span class="toc-text">测试相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.16.1.</span> <span class="toc-text">功能测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.16.2.</span> <span class="toc-text">性能测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7%E6%B5%8B%E8%AF%95"><span class="toc-number">1.16.3.</span> <span class="toc-text">安全性测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%B5%8B%E8%AF%95"><span class="toc-number">1.16.4.</span> <span class="toc-text">其他测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95-2"><span class="toc-number">1.16.5.</span> <span class="toc-text">单元测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95"><span class="toc-number">1.16.6.</span> <span class="toc-text">集成测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%B5%8B%E8%AF%95"><span class="toc-number">1.16.7.</span> <span class="toc-text">系统测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%A9%B1%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">1.16.8.</span> <span class="toc-text">数据驱动测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Django%E4%B8%AD%E7%9A%84%E6%B5%8B%E8%AF%95"><span class="toc-number">1.16.9.</span> <span class="toc-text">Django中的测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95-2"><span class="toc-number">1.16.10.</span> <span class="toc-text">性能测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E8%B0%83%E8%AF%95"><span class="toc-number">1.17.</span> <span class="toc-text">项目调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E7%9B%B8%E5%85%B3"><span class="toc-number">1.18.</span> <span class="toc-text">部署相关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E7%9B%B8%E5%85%B3"><span class="toc-number">1.19.</span> <span class="toc-text">性能相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E4%BC%98%E5%8C%96%E4%B8%A4%E5%A4%A7%E5%AE%9A%E5%BE%8B%EF%BC%9A"><span class="toc-number">1.19.1.</span> <span class="toc-text">网站优化两大定律：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Django%E6%A1%86%E6%9E%B6"><span class="toc-number">1.19.2.</span> <span class="toc-text">Django框架</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93-3"><span class="toc-number">1.19.3.</span> <span class="toc-text">数据库</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/08/15/C-CrashCourse/c-games/%E7%8C%9C%E6%95%B0%E5%AD%97/" title="猜数字">猜数字</a><time datetime="2022-08-14T22:45:19.000Z" title="发表于 15-08-2022 00:45:19">15-08-2022</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/08/15/C-CrashCourse/c-mordern-approch/02-C%E8%AF%AD%E8%A8%80%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" title="02-C语言基本概念">02-C语言基本概念</a><time datetime="2022-08-14T22:45:19.000Z" title="发表于 15-08-2022 00:45:19">15-08-2022</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/08/15/C-CrashCourse/c-mordern-approch/01-C%E8%AF%AD%E8%A8%80%E6%A6%82%E8%AE%BA/" title="01-C语言概论">01-C语言概论</a><time datetime="2022-08-14T22:45:19.000Z" title="发表于 15-08-2022 00:45:19">15-08-2022</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/08/15/C-CrashCourse/c-mordern-approch/03-C%E8%AF%AD%E8%A8%80%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" title="03-C语言基本概念">03-C语言基本概念</a><time datetime="2022-08-14T22:45:19.000Z" title="发表于 15-08-2022 00:45:19">15-08-2022</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/08/15/C-CrashCourse/c-mordern-approch/04-%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/" title="04-格式化输入输出">04-格式化输入输出</a><time datetime="2022-08-14T22:45:19.000Z" title="发表于 15-08-2022 00:45:19">15-08-2022</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By GreenSeaa</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>